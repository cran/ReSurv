<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Gabriele Pittarello, Emil Hofman" />

<meta name="date" content="2024-11-14" />

<title>A Machine Learning Approach Based On Survival Analysis For IBNR Frequencies In Non-Life Reserving</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">A Machine Learning Approach Based On
Survival Analysis For IBNR Frequencies In Non-Life Reserving</h1>
<h4 class="author">Gabriele Pittarello, Emil Hofman</h4>
<h4 class="date">2024-11-14</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>In this vignette, we provide the supplementary material to replicate
the results of the manuscript <strong>A machine learning approach based
on survival analysis for IBNR frequencies in non-life
reserving</strong>.</p>
<p>We remark that the real data that we used to obtain the results that
we included in the manuscript are private and will not be shared.</p>
<p>With reference to the code related to the simulation case study, we
wanted to make this vignette quickly reproducible and drop extensive
computations. The full code that we implemented can be found at the
GitHub repository <a href="https://github.com/gpitt71/resurv-replication-code">resurv-replication-code</a>.</p>
<p>For optimising the hyperparameters included in this vignette, we used
the procedure shown in the <a href="https://github.com/gpitt71/ReSurv/blob/main/vignettes/hp_tuning.Rmd">Hyperparameters
Tuning Vignette</a> .</p>
<div id="load-the-pacakge" class="section level2">
<h2>Load the pacakge</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(ReSurv)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">use_virtualenv</span>(<span class="st">&quot;pyresurv&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
</div>
</div>
<div id="figure-1" class="section level1">
<h1>Figure 1</h1>
<p>We first fit simulate and pre-process some data from Scenario
Delta.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>input_data <span class="ot">&lt;-</span> <span class="fu">data_generator</span>(<span class="at">random_seed =</span> <span class="dv">7</span>,</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>                             <span class="at">scenario =</span> <span class="dv">3</span>,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>                             <span class="at">time_unit =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">360</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>                             <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>                             <span class="at">period_exposure =</span> <span class="dv">200</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>individual_data <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(input_data,</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>                                    <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>                                    <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>                                    <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>                                    <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>                                    <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>                                    <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>                                    <span class="at">output_time_granularity =</span> <span class="st">&quot;quarters&quot;</span>,</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>                                    <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>                                    <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>                                    <span class="at">calendar_period_extrapolation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>We fit a XGB model with optimal hyperparameters.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>hparameters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">params =</span> <span class="fu">list</span>(<span class="at">booster =</span> <span class="st">&quot;gbtree&quot;</span>,</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>                                  <span class="at">eta =</span> <span class="fl">0.2234094</span>,</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>                                  <span class="at">subsample =</span> <span class="fl">0.8916594</span>,</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>                                  <span class="at">alpha =</span> <span class="fl">12.44775</span>,</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>                                  <span class="at">lambda =</span> <span class="fl">5.714286</span>,</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>                                  <span class="at">min_child_weight =</span> <span class="fl">4.211996</span>,</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>                                  <span class="at">max_depth =</span> <span class="dv">2</span>),</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>                    <span class="at">print_every_n =</span> <span class="dv">0</span>,</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>                    <span class="at">nrounds =</span> <span class="dv">3000</span>,</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>                    <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>                    <span class="at">early_stopping_rounds =</span> <span class="dv">500</span>)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>resurv_fit <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>                     <span class="at">hazard_model =</span> <span class="st">&quot;XGB&quot;</span>,</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>                     <span class="at">hparameters =</span> hparameters)</span></code></pre></div>
<p>We predict for different time granularities.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>resurv_fit_predict_q <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit,</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>                                <span class="at">grouping_method =</span> <span class="st">&quot;probability&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>individual_data_y <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(input_data,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>                                      <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>                                      <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>                                      <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>                                      <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>                                      <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>                                      <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>                                      <span class="at">output_time_granularity =</span> <span class="st">&quot;years&quot;</span>,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>                                      <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>                                      <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>                                      <span class="at">calendar_period_extrapolation =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>resurv_fit_predict_y <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit,</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>                                <span class="at">newdata =</span> individual_data_y,</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>                                <span class="at">grouping_method =</span> <span class="st">&quot;probability&quot;</span>)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>individual_data_m <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(input_data,</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>                                      <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>                                      <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>                                      <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>                                      <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>                                      <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>                                      <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>                                      <span class="at">output_time_granularity =</span> <span class="st">&quot;months&quot;</span>,</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>                                      <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>                                      <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>                                      <span class="at">calendar_period_extrapolation =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>resurv_fit_predict_m <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit,</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>                                <span class="at">newdata =</span> individual_data_m,</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>                                <span class="at">grouping_method =</span> <span class="st">&quot;probability&quot;</span>)</span></code></pre></div>
<p>We also plot the Chain-Ladder (CL) development factors for Monthly
and Quarterly granularities</p>
<div id="chain-ladder-monthly---figure-1a" class="section level2">
<h2>Chain-Ladder (Monthly) - Figure 1a</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>ticks_at <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">48</span>, <span class="dv">4</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>labels_as <span class="ot">&lt;-</span> <span class="fu">as.character</span>(ticks_at)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>cl_months <span class="ot">&lt;-</span> individual_data_m<span class="sc">$</span>training.data <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="dv">48</span> <span class="sc">-</span> DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="fu">arrange</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I), <span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  <span class="fu">group_by</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">df_o =</span> <span class="fu">sum</span>(I_cum <span class="sc">*</span> (</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>  )) <span class="sc">/</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    <span class="fu">sum</span>(I_cum_lag <span class="sc">*</span> (</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>      AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    )),</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  <span class="at">I =</span> <span class="fu">sum</span>(I <span class="sc">*</span> (</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o_join =</span> DP_o <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>cl_months <span class="sc">%&gt;%</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  <span class="fu">filter</span>(DP_o <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DP_o,</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>             <span class="at">y =</span> df_o)) <span class="sc">+</span></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;#454555&quot;</span>) <span class="sc">+</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Chain ladder&quot;</span>,</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Development month&quot;</span>,</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Development factor&quot;</span>) <span class="sc">+</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="fl">2.5</span> <span class="sc">+</span> .<span class="dv">01</span>) <span class="sc">+</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> ticks_at,</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>                     <span class="at">labels =</span> labels_as) <span class="sc">+</span></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="fu">rel</span>(<span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>))</span></code></pre></div>
</div>
<div id="chain-ladder-quarterly---figure-1b" class="section level2">
<h2>Chain-Ladder (Quarterly) - Figure 1b</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>cl_years <span class="ot">&lt;-</span> resurv_fit<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="fu">arrange</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I), <span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>  <span class="fu">group_by</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">df_o =</span> <span class="fu">sum</span>(I_cum <span class="sc">*</span> (</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(resurv_fit<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  )) <span class="sc">/</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    <span class="fu">sum</span>(I_cum_lag <span class="sc">*</span> (</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>      AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(resurv_fit<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    )),</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>  <span class="at">I =</span> <span class="fu">sum</span>(I <span class="sc">*</span> (</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(resurv_fit<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o_join =</span> DP_o <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>cl_years <span class="sc">%&gt;%</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>  <span class="fu">filter</span>(DP_o <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DP_o, <span class="at">y =</span> df_o)) <span class="sc">+</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;#454555&quot;</span>) <span class="sc">+</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Chain ladder&quot;</span>,</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Development quarter&quot;</span>,</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Development factor&quot;</span>) <span class="sc">+</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="dv">4</span> <span class="sc">+</span> .<span class="dv">01</span>) <span class="sc">+</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="fu">rel</span>(<span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>))</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>ticks_at <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">16</span>, <span class="at">by =</span> <span class="dv">2</span>)</span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>labels_as <span class="ot">&lt;-</span> <span class="fu">as.character</span>(ticks_at)</span></code></pre></div>
<p>For different granularities and feature combinations we plot the XGB
feature dependent development factors. ` ## XGB (Quarterly) - Figure
1f</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>resurv_fit_predict_q<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> <span class="dv">15</span> <span class="sc">&amp;</span> claim_type <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  resurv_fit_predict_q,</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;XGB: Accident Quarter 15 Claim Type 1&quot;</span>,</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  <span class="at">x_text_par =</span> <span class="st">&quot;Development Quarter&quot;</span>,</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">30</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="xgb-quarterly---figure-1g" class="section level2">
<h2>XGB (Quarterly) - Figure 1g</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>resurv_fit_predict_q<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>  resurv_fit_predict_q,</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;XGB: Accident Quarter 15 Claim Type 0&quot;</span>,</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>  <span class="at">x_text_par =</span> <span class="st">&quot;Development Quarter&quot;</span>,</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  <span class="at">ylim_par =</span> <span class="dv">4</span>,</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">29</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="xgb-quarterly---figure-1h" class="section level2">
<h2>XGB (Quarterly) - Figure 1h</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">16</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>resurv_fit_predict_q<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  resurv_fit_predict_q,</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;XGB: Accident Quarter 16 Claim Type 0&quot;</span>,</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="at">x_text_par =</span> <span class="st">&quot;Development Quarter&quot;</span>,</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>  <span class="at">ylim_par =</span> <span class="dv">4</span>,</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">31</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="xgb-monthly---figure-1c" class="section level2">
<h2>XGB (Monthly) - Figure 1c</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>resurv_fit_predict_m<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  resurv_fit_predict_m,</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;XGB: Accident Month 7 Claim Type 1&quot;</span>,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="at">x_text_par =</span> <span class="st">&quot;Development Month&quot;</span>,</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  <span class="at">color_par =</span> <span class="st">&quot;#a71429&quot;</span>,</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  <span class="at">ylim_par =</span> <span class="dv">10</span>,</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">14</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="xgb-monthly---figure-1d" class="section level2">
<h2>XGB (Monthly) - Figure 1d</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">9</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>resurv_fit_predict_m<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  resurv_fit_predict_m,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;XGB: Accident Month 9 Claim Type 0&quot;</span>,</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  <span class="at">x_text_par =</span> <span class="st">&quot;Development Month&quot;</span>,</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="at">color_par =</span> <span class="st">&quot;#a71429&quot;</span>,</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  <span class="at">ylim_par =</span> <span class="fl">2.5</span>,</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">17</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="xgb-monthly---figure-1e" class="section level2">
<h2>XGB (Monthly) - Figure 1e</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">36</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>resurv_fit_predict_m<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  resurv_fit_predict_m,</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;XGB: Accident Month 36 Claim Type 0&quot;</span>,</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>  <span class="at">color_par =</span> <span class="st">&quot;#a71429&quot;</span>,</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>  <span class="at">x_text_par =</span> <span class="st">&quot;Development Month&quot;</span>,</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>  <span class="at">ylim_par =</span> <span class="fl">2.5</span>,</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">71</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="table-2" class="section level1">
<h1>Table 2</h1>
<p>The models likelihood can be extracted using the following commands.
Table 2 shows the average negative log-likelihood for each scenario over
the different simulations, here we show the results for XGB, scenario
Delta and simulation number 7.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>resurv_fit<span class="sc">$</span>is_lkh</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>resurv_fit<span class="sc">$</span>os_lkh</span></code></pre></div>
</div>
<div id="fitted-survival-curve---figure-4-and-figure-5" class="section level1">
<h1>Fitted Survival Curve - Figure 4 and Figure 5</h1>
<p>We show how to plot the fitted survival function for scenario Alpha
and scenario Delta against the true survival function.</p>
<div id="figure-4" class="section level2">
<h2>Figure 4</h2>
<p>We find the true Survival Function for scenario Alpha, claim type
1.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="dv">30</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">1440</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> <span class="fl">1.15129</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>beta1 <span class="ot">&lt;-</span> <span class="fl">1.95601</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>f_correct_s0 <span class="ot">&lt;-</span> <span class="cf">function</span>(t, alpha, beta, lambda, k, b, beta_coef) {</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  inner <span class="ot">&lt;-</span> lambda <span class="sc">*</span> <span class="fu">exp</span>(beta_coef) <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> (alpha <span class="sc">*</span> k))</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>  element_one <span class="ot">&lt;-</span> <span class="sc">-</span>beta <span class="sc">^</span> alpha <span class="sc">*</span> (inner) <span class="sc">^</span> (alpha <span class="sc">*</span> k)</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  element_two <span class="ot">&lt;-</span> (t <span class="sc">^</span> (<span class="sc">-</span>alpha <span class="sc">*</span> k) <span class="sc">-</span> b <span class="sc">^</span> (<span class="sc">-</span>alpha <span class="sc">*</span> k))</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  <span class="fu">exp</span>(element_one <span class="sc">*</span> element_two)</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>}</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>c_correct_grouped <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(i, i <span class="sc">+</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>  n_t <span class="ot">&lt;-</span> <span class="fu">length</span>(t)</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>  calculation <span class="ot">&lt;-</span> <span class="fu">f_correct_s0</span>(t, alpha, beta, lambda, k, b, beta0)</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>  c_correct_grouped[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> calculation) <span class="sc">/</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>    n_t</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>}</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>c_correct_grouped <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, c_correct_grouped[<span class="dv">1</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>c_correct_grouped1 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(i, i <span class="sc">+</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a>  n_t <span class="ot">&lt;-</span> <span class="fu">length</span>(t)</span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a>  calculation <span class="ot">&lt;-</span> <span class="fu">f_correct_s0</span>(t, alpha, beta, lambda, k, b, beta1)</span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>  c_correct_grouped1[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> calculation) <span class="sc">/</span></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>    n_t</span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>}</span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>c_correct_grouped1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, c_correct_grouped1[<span class="dv">1</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>true_curve <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a>  <span class="st">&quot;DP_rev_i&quot;</span> <span class="ot">=</span> (b <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">seq</span>(<span class="dv">0</span>, (b <span class="sc">-</span> <span class="dv">1</span>), <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a>  <span class="st">&quot;S_i&quot;</span> <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> (c_correct_grouped1),</span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a>  <span class="st">&quot;model_label&quot;</span> <span class="ot">=</span> <span class="st">&quot;TRUE&quot;</span></span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a>)</span></code></pre></div>
<p>We generate the data for Scenario Alpha.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>input_data <span class="ot">&lt;-</span> <span class="fu">data_generator</span>(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  <span class="at">random_seed =</span> <span class="dv">1</span>,</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="at">scenario =</span> <span class="dv">0</span>,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="at">time_unit =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">360</span>,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  <span class="at">period_exposure =</span> <span class="dv">200</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>individual_data <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>  input_data,</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>  <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>  <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>  <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>  <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>  <span class="at">output_time_granularity =</span> <span class="st">&quot;quarters&quot;</span>,</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>  <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>  <span class="at">calendar_period_extrapolation =</span> <span class="cn">FALSE</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>)</span></code></pre></div>
<p>Here the optimal hyperparameters for XGB and NN for the generated
data set.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>hparameters_xgb_01 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    <span class="at">booster =</span> <span class="st">&quot;gbtree&quot;</span>,</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fl">0.9887265</span>,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    <span class="at">subsample =</span> <span class="fl">0.7924135</span>,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">10.85342</span>,</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="fl">6.213317</span>,</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>    <span class="at">min_child_weight =</span> <span class="fl">3.042204</span>,</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="dv">1</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>  ),</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>  <span class="at">print_every_n =</span> <span class="dv">0</span>,</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>  <span class="at">nrounds =</span> <span class="dv">3000</span>,</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>  <span class="at">early_stopping_rounds =</span> <span class="dv">500</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>)</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>hparameters_nn_01 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>  <span class="at">num_layers =</span> <span class="dv">2</span>,</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>  <span class="at">early_stopping =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>  <span class="at">patience =</span> <span class="dv">350</span>,</span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>  <span class="at">network_structure =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>  <span class="at">num_nodes =</span> <span class="dv">10</span>,</span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>  <span class="at">activation =</span> <span class="st">&quot;SELU&quot;</span>,</span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>  <span class="at">optim =</span> <span class="st">&quot;SGD&quot;</span>,</span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>  <span class="at">lr =</span> <span class="fl">0.2741031</span>,</span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>  <span class="at">xi =</span> <span class="fl">0.3829451</span>,</span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>  <span class="at">epsilon =</span> <span class="dv">0</span>,</span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="fu">as.integer</span>(<span class="dv">5000</span>),</span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="fu">as.integer</span>(<span class="dv">5500</span>),</span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a>  <span class="at">num_workers =</span> <span class="dv">0</span>,</span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>  <span class="at">tie =</span> <span class="st">&quot;Efron&quot;</span></span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a>)</span></code></pre></div>
<p>We fit COX, NN and XGB on the simulated data.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>resurv_fit_cox_01 <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>                             <span class="at">hazard_model =</span> <span class="st">&quot;COX&quot;</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>resurv_fit_nn_01 <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>                             <span class="at">hazard_model =</span> <span class="st">&quot;NN&quot;</span>,</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>                             <span class="at">hparameters =</span> hparameters_nn_01)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>resurv_fit_xgb_01 <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>                             <span class="at">hazard_model =</span> <span class="st">&quot;XGB&quot;</span>,</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>                             <span class="at">hparameters =</span> hparameters_xgb_01)</span></code></pre></div>
<p>Extract the fitted survival curve.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>hazard_frame_updated_cox <span class="ot">&lt;-</span> resurv_fit_cox_01<span class="sc">$</span>hazard_frame</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>hazard_frame_updated_nn <span class="ot">&lt;-</span> resurv_fit_nn_01<span class="sc">$</span>hazard_frame</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>hazard_frame_updated_xgb <span class="ot">&lt;-</span> resurv_fit_xgb_01<span class="sc">$</span>hazard_frame</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>cond_1 <span class="ot">&lt;-</span> hazard_frame_updated_cox<span class="sc">$</span>AP_i <span class="sc">==</span> <span class="dv">13</span> <span class="sc">&amp;</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  hazard_frame_updated_cox<span class="sc">$</span>claim_type <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>estimated_cox <span class="ot">&lt;-</span> hazard_frame_updated_cox[, <span class="fu">c</span>(<span class="st">&quot;S_i&quot;</span>, <span class="st">&quot;DP_rev_i&quot;</span>)]</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>estimated_cox <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(estimated_cox)[, model_label <span class="sc">:=</span> <span class="st">&quot;COX&quot;</span>]</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>cond_2 <span class="ot">&lt;-</span> hazard_frame_updated_nn<span class="sc">$</span>AP_i <span class="sc">==</span> <span class="dv">13</span> <span class="sc">&amp;</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>  hazard_frame_updated_nn<span class="sc">$</span>claim_type <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>estimated_nn <span class="ot">&lt;-</span> hazard_frame_updated_nn[cond_2, <span class="fu">c</span>(<span class="st">&quot;S_i&quot;</span>, <span class="st">&quot;DP_rev_i&quot;</span>)]</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>estimated_nn <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(estimated_nn)[, model_label <span class="sc">:=</span> <span class="st">&quot;NN&quot;</span>]</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>cond_3 <span class="ot">&lt;-</span> hazard_frame_updated_xgb<span class="sc">$</span>AP_i <span class="sc">==</span> <span class="dv">13</span> <span class="sc">&amp;</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>  hazard_frame_updated_xgb<span class="sc">$</span>claim_type <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>estimated_xgb <span class="ot">&lt;-</span> hazard_frame_updated_xgb[, <span class="fu">c</span>(<span class="st">&quot;S_i&quot;</span>, <span class="st">&quot;DP_rev_i&quot;</span>)]</span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>estimated_xgb <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(estimated_xgb)[cond3, model_label <span class="sc">:=</span> <span class="st">&quot;XGB&quot;</span>]</span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">rbind</span>(estimated_cox, estimated_nn, estimated_xgb)</span></code></pre></div>
<p>Plot the fitted survival curve for the three.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> dt, <span class="fu">aes</span>(<span class="at">x =</span> DP_rev_i, <span class="at">y =</span> S_i, <span class="at">color =</span> model_label)) <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span> model_label) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&quot;line&quot;</span>,</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    <span class="at">x =</span> true_curve<span class="sc">$</span>DP_rev_i,</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>    <span class="at">y =</span> true_curve<span class="sc">$</span>S_i,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>    <span class="at">lty =</span> <span class="dv">2</span>,</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">440</span>, <span class="dv">940</span>),</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;1440&quot;</span>, <span class="st">&quot;1000&quot;</span>, <span class="st">&quot;500&quot;</span>)</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">001</span>)) <span class="sc">+</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Development time&quot;</span>) <span class="sc">+</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Survival function&quot;</span>) <span class="sc">+</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;Model&quot;</span>,</span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>                     <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#AAAABC&quot;</span>, <span class="st">&quot;#a71429&quot;</span>, <span class="st">&quot;#4169E1&quot;</span>)) <span class="sc">+</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(</span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a>      <span class="at">angle =</span> <span class="dv">90</span>,</span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a>      <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="dv">1</span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a>    )</span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="figure-5" class="section level2">
<h2>Figure 5</h2>
<p>We find the true Survival Function for scenario Delta, accident day
691 and claim type 1.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>my_ap <span class="ot">=</span> <span class="dv">691</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>period_function <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  <span class="st">&quot;</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="st">  Add monthly seasonal effect starting from daily input.</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="st">  &quot;</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">floor</span>((x <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">30</span>)</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  </span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  <span class="cf">if</span> ((tmp <span class="sc">%%</span> <span class="dv">12</span>) <span class="sc">%in%</span> (<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>))) {</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>    <span class="fu">return</span>(<span class="sc">-</span><span class="fl">0.3</span>)</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>  }</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>  <span class="cf">if</span> ((tmp <span class="sc">%%</span> <span class="dv">12</span>) <span class="sc">%in%</span> (<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>))) {</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fl">0.4</span>)</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>  }</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>  <span class="cf">if</span> ((tmp <span class="sc">%%</span> <span class="dv">12</span>) <span class="sc">%in%</span> (<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>))) {</span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>    <span class="fu">return</span>(<span class="sc">-</span><span class="fl">0.7</span>)</span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>  }</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a>  <span class="cf">if</span> ((tmp <span class="sc">%%</span> <span class="dv">12</span>) <span class="sc">%in%</span> (<span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">0</span>, <span class="dv">1</span>))) {</span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>    <span class="co">#0 instead of 12</span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fl">0.1</span>)</span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a>  }</span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>}</span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="dv">30</span></span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">1440</span></span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> <span class="fl">1.15129</span></span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a>beta1 <span class="ot">&lt;-</span> <span class="fl">1.95601</span> <span class="sc">+</span> <span class="fu">period_function</span>(my_ap)</span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a>f_correct_s0 <span class="ot">&lt;-</span> <span class="cf">function</span>(t, alpha, beta, lambda, k, b, beta_coef) {</span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a>  element_1 <span class="ot">&lt;-</span> <span class="sc">-</span>beta <span class="sc">^</span> alpha</span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a>  element_2 <span class="ot">&lt;-</span> lambda <span class="sc">*</span> <span class="fu">exp</span>(beta_coef) <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> (alpha <span class="sc">*</span> k))</span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a>  element_ <span class="dv">3</span> <span class="ot">&lt;-</span> t <span class="sc">^</span> (<span class="sc">-</span>alpha <span class="sc">*</span> k) <span class="sc">-</span> b <span class="sc">^</span> (<span class="sc">-</span>alpha <span class="sc">*</span> k)</span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a>  <span class="fu">exp</span>(element_1 <span class="sc">*</span> (element_2) <span class="sc">^</span> (alpha <span class="sc">*</span> k) <span class="sc">*</span> ())</span>
<span id="cb20-38"><a href="#cb20-38" tabindex="-1"></a>}</span>
<span id="cb20-39"><a href="#cb20-39" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" tabindex="-1"></a>c_correct_grouped <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb20-41"><a href="#cb20-41" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb20-42"><a href="#cb20-42" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(i, i <span class="sc">+</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb20-43"><a href="#cb20-43" tabindex="-1"></a>  n_t <span class="ot">&lt;-</span> <span class="fu">length</span>(t)</span>
<span id="cb20-44"><a href="#cb20-44" tabindex="-1"></a>  calculation <span class="ot">&lt;-</span> <span class="fu">f_correct_s0</span>(t, alpha, beta, lambda, k, b, beta0)</span>
<span id="cb20-45"><a href="#cb20-45" tabindex="-1"></a>  c_correct_grouped[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> calculation) <span class="sc">/</span></span>
<span id="cb20-46"><a href="#cb20-46" tabindex="-1"></a>    n_t</span>
<span id="cb20-47"><a href="#cb20-47" tabindex="-1"></a>}</span>
<span id="cb20-48"><a href="#cb20-48" tabindex="-1"></a>c_correct_grouped <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, c_correct_grouped[<span class="dv">1</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb20-49"><a href="#cb20-49" tabindex="-1"></a></span>
<span id="cb20-50"><a href="#cb20-50" tabindex="-1"></a>c_correct_grouped1 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb20-51"><a href="#cb20-51" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb20-52"><a href="#cb20-52" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(i, i <span class="sc">+</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb20-53"><a href="#cb20-53" tabindex="-1"></a>  n_t <span class="ot">&lt;-</span> <span class="fu">length</span>(t)</span>
<span id="cb20-54"><a href="#cb20-54" tabindex="-1"></a>  calculation <span class="ot">&lt;-</span> <span class="fu">f_correct_s0</span>(t, alpha, beta, lambda, k, b, beta1)</span>
<span id="cb20-55"><a href="#cb20-55" tabindex="-1"></a>  c_correct_grouped1[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> calculation) <span class="sc">/</span> n_t</span>
<span id="cb20-56"><a href="#cb20-56" tabindex="-1"></a>}</span>
<span id="cb20-57"><a href="#cb20-57" tabindex="-1"></a>c_correct_grouped1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, c_correct_grouped1[<span class="dv">1</span><span class="sc">:</span>(b <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb20-58"><a href="#cb20-58" tabindex="-1"></a></span>
<span id="cb20-59"><a href="#cb20-59" tabindex="-1"></a>true_curve <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb20-60"><a href="#cb20-60" tabindex="-1"></a>  <span class="st">&quot;DP_rev_i&quot;</span> <span class="ot">=</span> (b <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">seq</span>(<span class="dv">0</span>, (b <span class="sc">-</span> <span class="dv">1</span>), <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb20-61"><a href="#cb20-61" tabindex="-1"></a>  <span class="st">&quot;S_i&quot;</span> <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> (c_correct_grouped1),</span>
<span id="cb20-62"><a href="#cb20-62" tabindex="-1"></a>  <span class="st">&quot;model_label&quot;</span> <span class="ot">=</span> <span class="st">&quot;TRUE&quot;</span></span>
<span id="cb20-63"><a href="#cb20-63" tabindex="-1"></a>)</span></code></pre></div>
<p>We generate a data set from scenario Delta.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>input_data <span class="ot">&lt;-</span> <span class="fu">data_generator</span>(</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>  <span class="at">random_seed =</span> <span class="dv">1</span>,</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>  <span class="at">scenario =</span> <span class="dv">3</span>,</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>  <span class="at">time_unit =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">360</span>,</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>  <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="at">period_exposure =</span> <span class="dv">200</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>)</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>individual_data <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>  input_data,</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>  <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>  <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>  <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>  <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>  <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>  <span class="at">output_time_granularity =</span> <span class="st">&quot;quarters&quot;</span>,</span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a>  <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>  <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a>  <span class="at">calendar_period_extrapolation =</span> F</span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a>)</span></code></pre></div>
<p>Here the optimal parameters for the data set above for XGB and
NN.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>hparameters_xgb_31 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>    <span class="at">booster =</span> <span class="st">&quot;gbtree&quot;</span>,</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fl">0.1801517</span>,</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>    <span class="at">subsample =</span> <span class="fl">0.8768306</span>,</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.6620562</span>,</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="fl">1.379897</span>,</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>    <span class="at">min_child_weight =</span> <span class="fl">15.61339</span>,</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="dv">2</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>  ),</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>  <span class="at">print_every_n =</span> <span class="dv">0</span>,</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>  <span class="at">nrounds =</span> <span class="dv">3000</span>,</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>  <span class="at">early_stopping_rounds =</span> <span class="dv">500</span></span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>)</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>hparameters_nn_31 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>  <span class="at">num_layers =</span> <span class="dv">2</span>,</span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>  <span class="at">early_stopping =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>  <span class="at">patience =</span> <span class="dv">350</span>,</span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>  <span class="at">network_structure =</span> <span class="cn">NULL</span>,</span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>  <span class="at">num_nodes =</span> <span class="dv">2</span>,</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>  <span class="at">activation =</span> <span class="st">&quot;LeakyReLU&quot;</span>,</span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a>  <span class="at">optim =</span> <span class="st">&quot;Adam&quot;</span>,</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a>  <span class="at">lr =</span> <span class="fl">0.3542422</span>,</span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a>  <span class="at">xi =</span> <span class="fl">0.1803953</span>,</span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>  <span class="at">epsilon =</span> <span class="dv">0</span>,</span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="fu">as.integer</span>(<span class="dv">5000</span>),</span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="fu">as.integer</span>(<span class="dv">5500</span>),</span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a>  <span class="at">num_workers =</span> <span class="dv">0</span>,</span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a>  <span class="at">tie =</span> <span class="st">&quot;Efron&quot;</span></span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a>)</span></code></pre></div>
<p>We fit COX, NN and XGB.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>resurv_fit_cox_31 <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data, <span class="at">hazard_model =</span> <span class="st">&quot;COX&quot;</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>resurv_fit_nn_31 <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>                           <span class="at">hazard_model =</span> <span class="st">&quot;NN&quot;</span>,</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>                           <span class="at">hparameters =</span> hparameters_nn_31)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>resurv_fit_xgb_31 <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>                            <span class="at">hazard_model =</span> <span class="st">&quot;XGB&quot;</span>,</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>                            <span class="at">hparameters =</span> hparameters_xgb_31)</span></code></pre></div>
<p>Extract the fitted survival curve.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>hazard_frame_updated_cox <span class="ot">&lt;-</span> resurv_fit_cox_31<span class="sc">$</span>hazard_frame</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>hazard_frame_updated_nn <span class="ot">&lt;-</span> resurv_fit_nn_31<span class="sc">$</span>hazard_frame</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>hazard_frame_updated_xgb <span class="ot">&lt;-</span> resurv_fit_xgb_31<span class="sc">$</span>hazard_frame</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>cond_1 <span class="ot">&lt;-</span> hazard_frame_updated_cox<span class="sc">$</span>AP_i <span class="sc">==</span> my_ap <span class="sc">&amp;</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>  hazard_frame_updated_cox<span class="sc">$</span>claim_type <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>estimated_cox <span class="ot">&lt;-</span> hazard_frame_updated_cox[cond_1, <span class="fu">c</span>(<span class="st">&quot;S_i&quot;</span>, <span class="st">&quot;DP_rev_i&quot;</span>)]</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>estimated_cox <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(estimated_cox)[, model_label <span class="sc">:=</span> <span class="st">&#39;COX&#39;</span>]</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>cond_2 <span class="ot">&lt;-</span> hazard_frame_updated_nn<span class="sc">$</span>AP_i <span class="sc">==</span> my_ap <span class="sc">&amp;</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>  hazard_frame_updated_nn<span class="sc">$</span>claim_type <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>estimated_nn <span class="ot">&lt;-</span> hazard_frame_updated_nn[cond_2, <span class="fu">c</span>(<span class="st">&quot;S_i&quot;</span>, <span class="st">&quot;DP_rev_i&quot;</span>)]</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>estimated_nn <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(estimated_nn)[, model_label <span class="sc">:=</span> <span class="st">&#39;NN&#39;</span>]</span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>cond_3 <span class="ot">&lt;-</span> hazard_frame_updated_xgb<span class="sc">$</span>AP_i <span class="sc">==</span> my_ap <span class="sc">&amp;</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>  hazard_frame_updated_xgb<span class="sc">$</span>claim_type <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>estimated_xgb <span class="ot">&lt;-</span> hazard_frame_updated_xgb[cond_3, <span class="fu">c</span>(<span class="st">&quot;S_i&quot;</span>, <span class="st">&quot;DP_rev_i&quot;</span>)]</span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>estimated_xgb <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(estimated_xgb)[, model_label <span class="sc">:=</span> <span class="st">&#39;XGB&#39;</span>]</span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">rbind</span>(estimated_cox, estimated_nn, estimated_xgb)</span></code></pre></div>
<p>Plot the fitted survival curve for the three models.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> dt, <span class="fu">aes</span>(<span class="at">x =</span> DP_rev_i, <span class="at">y =</span> S_i, <span class="at">color =</span> model_label)) <span class="sc">+</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  <span class="fu">facet_grid</span>( <span class="sc">~</span> model_label) <span class="sc">+</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&#39;line&#39;</span>,</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>    <span class="at">x =</span> true_curve<span class="sc">$</span>DP_rev_i,</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>    <span class="at">y =</span> true_curve<span class="sc">$</span>S_i,</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>    <span class="at">lty =</span> <span class="dv">2</span>,</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">440</span>, <span class="dv">940</span>),</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;1440&quot;</span>, <span class="st">&quot;1000&quot;</span>, <span class="st">&quot;500&quot;</span>)</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">001</span>)) <span class="sc">+</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Development time&quot;</span>) <span class="sc">+</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Survival function&quot;</span>) <span class="sc">+</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;Model&quot;</span>,</span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>                     <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#AAAABC&quot;</span>, <span class="st">&quot;#a71429&quot;</span>, <span class="st">&quot;#4169E1&quot;</span>)) <span class="sc">+</span></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(</span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a>      <span class="at">angle =</span> <span class="dv">90</span>,</span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>      <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="dv">1</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>    )</span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="fitting-and-scoring" class="section level1">
<h1>Fitting and scoring</h1>
<p>In this Section we show how we fitted and scored our models. While we
only show an example for COX, the other models were fitted and scored in
a similar fashion.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>seed <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>scenario <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>input_data <span class="ot">&lt;-</span> <span class="fu">data_generator</span>(</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>  <span class="at">random_seed =</span> seed,</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>  <span class="at">scenario =</span> scenario,</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>  <span class="at">time_unit =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">360</span>,</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>  <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>  <span class="at">period_exposure =</span> <span class="dv">200</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>)</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>individual_data <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>  input_data,</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>  <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>  <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>  <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a>  <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>  <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a>  <span class="at">output_time_granularity =</span> <span class="st">&quot;quarters&quot;</span>,</span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>  <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>  <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>  <span class="at">calendar_period_extrapolation =</span> <span class="cn">FALSE</span></span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>)</span></code></pre></div>
<div id="fitting" class="section level2">
<h2>Fitting</h2>
<div id="time-to-fit-and-predict" class="section level3">
<h3>Time to fit and predict</h3>
<p>Measuring computation time.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>resurv_fit <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data, <span class="at">hazard_model =</span> <span class="st">&quot;COX&quot;</span>)</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>resurv_fit_predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit, <span class="at">grouping_method =</span> <span class="st">&quot;probability&quot;</span>)</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>() <span class="sc">-</span> start</span></code></pre></div>
</div>
</div>
<div id="scoring" class="section level2">
<h2>Scoring</h2>
<div id="scoring-on-a-quarterly-grid." class="section level3">
<h3>Scoring on a Quarterly grid.</h3>
<p>Total absolute relative error and total absolute error by calendar
time on a quarterly grid.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>conversion_factor <span class="ot">&lt;-</span> individual_data<span class="sc">$</span>conversion_factor</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>max_dp_i <span class="ot">&lt;-</span> <span class="dv">1440</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="co"># Compute the continuously Ranked Probability Score (CRPS) ----</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>crps_dt <span class="ot">&lt;-</span> ReSurv<span class="sc">::</span><span class="fu">survival_crps</span>(resurv_fit)</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>crps_result <span class="ot">&lt;-</span> <span class="fu">mean</span>(crps_dt<span class="sc">$</span>crps)</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a><span class="co"># Compute the ARE tot ----</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>true_output <span class="ot">&lt;-</span> resurv_fit<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>full.data <span class="sc">%&gt;%</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a>      <span class="fu">ceiling</span>(DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor),</span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a>    <span class="at">TR_o =</span> AP_o <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&lt;=</span> TR_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a>out_list <span class="ot">&lt;-</span> resurv_fit_predict<span class="sc">$</span>long_triangle_format_out</span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a>out <span class="ot">&lt;-</span> out_list<span class="sc">$</span>output_granularity</span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a><span class="co">#Total output</span></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a>score_total <span class="ot">&lt;-</span> out[, <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_o&quot;</span>, <span class="st">&quot;expected_counts&quot;</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ave =</span> I <span class="sc">-</span> expected_counts, <span class="at">abs_ave =</span> <span class="fu">abs</span>(ave)) <span class="sc">%&gt;%</span></span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a>  <span class="co"># from here it is reformulated for the are tot</span></span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(ave)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a>are_tot <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>abs_ave) <span class="sc">/</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>I)</span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" tabindex="-1"></a>dfs_output <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span></span>
<span id="cb28-46"><a href="#cb28-46" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-47"><a href="#cb28-47" tabindex="-1"></a>  <span class="fu">select</span>(AP_o, claim_type, DP_rev_o, f_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-48"><a href="#cb28-48" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-49"><a href="#cb28-49" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb28-50"><a href="#cb28-50" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" tabindex="-1"></a><span class="co">#Cashflow on output scale.Etc quarterly cashflow development</span></span>
<span id="cb28-52"><a href="#cb28-52" tabindex="-1"></a>score_diagonal <span class="ot">&lt;-</span> resurv_fit<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>full.data  <span class="sc">%&gt;%</span></span>
<span id="cb28-53"><a href="#cb28-53" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-54"><a href="#cb28-54" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb28-55"><a href="#cb28-55" tabindex="-1"></a>      <span class="fu">ceiling</span>(DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb28-56"><a href="#cb28-56" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb28-57"><a href="#cb28-57" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb28-58"><a href="#cb28-58" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb28-59"><a href="#cb28-59" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor)</span>
<span id="cb28-60"><a href="#cb28-60" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-61"><a href="#cb28-61" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-62"><a href="#cb28-62" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb28-63"><a href="#cb28-63" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-64"><a href="#cb28-64" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-65"><a href="#cb28-65" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(DP_rev_o)) <span class="sc">%&gt;%</span></span>
<span id="cb28-66"><a href="#cb28-66" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I)) <span class="sc">%&gt;%</span></span>
<span id="cb28-67"><a href="#cb28-67" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-68"><a href="#cb28-68" tabindex="-1"></a>  <span class="fu">left_join</span>(dfs_output, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-69"><a href="#cb28-69" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_hat =</span>  I_cum_lag <span class="sc">*</span> f_o,</span>
<span id="cb28-70"><a href="#cb28-70" tabindex="-1"></a>         <span class="at">RP_o =</span> <span class="fu">max</span>(DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-71"><a href="#cb28-71" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output[, <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)] <span class="sc">%&gt;%</span>  <span class="fu">distinct</span>()</span>
<span id="cb28-72"><a href="#cb28-72" tabindex="-1"></a>             , <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-73"><a href="#cb28-73" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb28-74"><a href="#cb28-74" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave2_diag =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(I_cum_hat) <span class="sc">-</span> <span class="fu">sum</span>(I_cum)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb28-75"><a href="#cb28-75" tabindex="-1"></a></span>
<span id="cb28-76"><a href="#cb28-76" tabindex="-1"></a>are_cal_q <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>abs_ave2_diag) <span class="sc">/</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>I)</span></code></pre></div>
<p>Scoring on an yearly grid.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>individual_data2 <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>  input_data,</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>  <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>  <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>  <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>  <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>  <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>  <span class="at">output_time_granularity =</span> <span class="st">&quot;years&quot;</span>,</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>  <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>  <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>  <span class="at">calendar_period_extrapolation =</span> F</span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>)</span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>resurv_predict_yearly <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit, </span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>                                 <span class="at">newdata =</span> individual_data2, </span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a>                                 <span class="at">grouping_method =</span> <span class="st">&quot;probability&quot;</span>)</span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>conversion_factor <span class="ot">&lt;-</span> individual_data2<span class="sc">$</span>conversion_factor</span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>max_dp_i <span class="ot">&lt;-</span> <span class="dv">1440</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>true_output <span class="ot">&lt;-</span> individual_data2<span class="sc">$</span>full.data <span class="sc">%&gt;%</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a>      <span class="fu">ceiling</span>(DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor),</span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a>    <span class="at">TR_o =</span> AP_o <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&lt;=</span> TR_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a>out_list_yearly <span class="ot">&lt;-</span> resurv_predict_yearly<span class="sc">$</span>long_triangle_format_out</span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a>out_yearly <span class="ot">&lt;-</span> out_list_yearly<span class="sc">$</span>output_granularity</span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a></span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a>dfs_output <span class="ot">&lt;-</span> out_yearly <span class="sc">%&gt;%</span></span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">4</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-45"><a href="#cb29-45" tabindex="-1"></a>  <span class="fu">select</span>(AP_o, claim_type, DP_rev_o, f_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-46"><a href="#cb29-46" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-47"><a href="#cb29-47" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb29-48"><a href="#cb29-48" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" tabindex="-1"></a>score_diagonal_yearly <span class="ot">&lt;-</span> individual_data2<span class="sc">$</span>full.data  <span class="sc">%&gt;%</span></span>
<span id="cb29-50"><a href="#cb29-50" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-51"><a href="#cb29-51" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb29-52"><a href="#cb29-52" tabindex="-1"></a>      <span class="fu">ceiling</span>(DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb29-53"><a href="#cb29-53" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb29-54"><a href="#cb29-54" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb29-55"><a href="#cb29-55" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb29-56"><a href="#cb29-56" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor)</span>
<span id="cb29-57"><a href="#cb29-57" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-58"><a href="#cb29-58" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-59"><a href="#cb29-59" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb29-60"><a href="#cb29-60" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-61"><a href="#cb29-61" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-62"><a href="#cb29-62" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(DP_rev_o)) <span class="sc">%&gt;%</span></span>
<span id="cb29-63"><a href="#cb29-63" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I)) <span class="sc">%&gt;%</span></span>
<span id="cb29-64"><a href="#cb29-64" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-65"><a href="#cb29-65" tabindex="-1"></a>  <span class="fu">left_join</span>(dfs_output, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-66"><a href="#cb29-66" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_hat =</span>  I_cum_lag <span class="sc">*</span> f_o,</span>
<span id="cb29-67"><a href="#cb29-67" tabindex="-1"></a>         <span class="at">RP_o =</span> <span class="fu">max</span>(DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-68"><a href="#cb29-68" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output[, <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)] <span class="sc">%&gt;%</span>  <span class="fu">distinct</span>()</span>
<span id="cb29-69"><a href="#cb29-69" tabindex="-1"></a>             , <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-70"><a href="#cb29-70" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb29-71"><a href="#cb29-71" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave2_diag =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(I_cum_hat) <span class="sc">-</span> <span class="fu">sum</span>(I_cum)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb29-72"><a href="#cb29-72" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" tabindex="-1"></a>are_cal_y <span class="ot">=</span> <span class="fu">sum</span>(score_diagonal_yearly<span class="sc">$</span>abs_ave2_diag) <span class="sc">/</span> </span>
<span id="cb29-74"><a href="#cb29-74" tabindex="-1"></a>  <span class="fu">sum</span>(score_diagonal_yearly<span class="sc">$</span>I)</span></code></pre></div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
