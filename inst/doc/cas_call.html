<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Gabriele Pittarello" />

<meta name="date" content="2024-11-14" />

<title>Claim Counts Prediction Using Individual Data</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Claim Counts Prediction Using Individual
Data</h1>
<h4 class="author">Gabriele Pittarello</h4>
<h4 class="date">2024-11-14</h4>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(ReSurv)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">use_virtualenv</span>(<span class="st">&quot;pyresurv&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
<p>In this vignette we show a pipeline for predicting individual claim
counts using the <code>ReSurv</code> package.</p>
<p>This vignette was created for the <em>2024 Reserving Call Paper
Program on Technology and the Reserving Actuary</em> of the Casualty
Actuarial Society (CAS) and the CAS Reserves Working Group. We would
like to thank the team of reviewers that provided feedback that improved
our package.</p>
<div id="installation" class="section level1">
<h1>Installation</h1>
<p>To install the developer version of the <code>ReSurv</code>
package.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;edhofman/resurv&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">library</span>(ReSurv)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">packageVersion</span>(<span class="st">&quot;ReSurv&quot;</span>)</span></code></pre></div>
<p>To handle the Python dependencies for <em>the first package
installation</em>, we suggest to create a dedicated virtual environment.
The remaining part of this Section can be disregard from users that are
not interested in using our models based on Neural Networks.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>ReSurv<span class="sc">::</span><span class="fu">install_pyresurv</span>()</span></code></pre></div>
<p>The default name of the virtual environment is
<code>&quot;pyresurv&quot;</code>.</p>
<p>We then suggest to refresh the R session and to import the
<code>ReSurv</code> package in R using</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">library</span>(ReSurv)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">use_virtualenv</span>(<span class="st">&quot;pyresurv&quot;</span>)</span></code></pre></div>
<div id="managing-multiple-package-dependencies" class="section level2">
<h2>Managing Multiple Package Dependencies</h2>
<p>For the case of multiple packages using isolated-package-environments
we suggest the following procedure. Below an example for
<code>pysparklyr</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>envname <span class="ot">&lt;-</span> <span class="st">&quot;./venv&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>ReSurv<span class="sc">::</span><span class="fu">install_pyresurv</span>(<span class="at">envname =</span> envname)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>pysparklyr<span class="sc">::</span><span class="fu">install_pyspark</span>(<span class="at">envname =</span> envname)</span></code></pre></div>
</div>
</div>
<div id="data-simulation" class="section level1">
<h1>Data Simulation</h1>
<p>We simulate a synthetic data set from scenario Alpha.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>input_data <span class="ot">&lt;-</span> <span class="fu">data_generator</span>(<span class="at">random_seed =</span> <span class="dv">7</span>,</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>                             <span class="at">scenario =</span> <span class="st">&quot;alpha&quot;</span>,</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>                             <span class="at">time_unit =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">360</span>,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>                             <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>                             <span class="at">period_exposure =</span> <span class="dv">200</span>)</span></code></pre></div>
<p>We inspect the data set.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">str</span>(input_data)</span></code></pre></div>
</div>
<div id="data-pre-processing" class="section level1">
<h1>Data Pre-Processing</h1>
<p>The data is pre-processed using the <code>IndividualDataPP</code>
function.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>individual_data <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(<span class="at">data =</span> input_data,</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>                                    <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>                                    <span class="at">continuous_features =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>                                    <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>                                    <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>                                    <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>                                    <span class="at">output_time_granularity =</span> <span class="st">&quot;quarters&quot;</span>,</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>                                    <span class="at">years =</span> <span class="dv">4</span>)</span></code></pre></div>
</div>
<div id="selection-of-the-hyper-parameters" class="section level1">
<h1>Selection of the hyper-parameters</h1>
<p>This Sections first shows the usage of the <code>ReSurvCV</code>
function for cross-validation. Secondly, we show how to combine the
<code>ReSurvCV</code> function into the
<code>ParBayesianOptimization</code>package routine for performing the
Bayesian Optimization of Hyperparameters.</p>
<div id="xgb-k-fold-cross-validation-cv" class="section level2">
<h2>XGB: K-Fold cross-validation (CV)</h2>
<p>Example of K-Fold cross-validation (CV) for the XGB model.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>resurv_cv_xgboost <span class="ot">&lt;-</span> <span class="fu">ReSurvCV</span>(<span class="at">IndividualDataPP =</span> individual_data,</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>                              <span class="at">model =</span> <span class="st">&quot;XGB&quot;</span>,</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>                              <span class="at">hparameters_grid =</span> <span class="fu">list</span>(<span class="at">booster =</span> <span class="st">&quot;gbtree&quot;</span>,</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                                                      <span class="at">eta =</span> <span class="fu">c</span>(.<span class="dv">001</span>),</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>                                                      <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>),</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>                                                      <span class="at">subsample =</span> <span class="fu">c</span>(<span class="dv">1</span>),</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>                                                      <span class="at">alpha =</span> <span class="fu">c</span>(<span class="dv">0</span>),</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>                                                      <span class="at">lambda =</span> <span class="fu">c</span>(<span class="dv">0</span>),</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>                                                      <span class="at">min_child_weight =</span> <span class="fu">c</span>(.<span class="dv">5</span>)),</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>                              <span class="at">print_every_n =</span> <span class="dv">1</span><span class="dt">L</span>,</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>                              <span class="at">nrounds =</span> <span class="dv">1</span>,</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>                              <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>                              <span class="at">verbose.cv =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>                              <span class="at">early_stopping_rounds =</span> <span class="dv">1</span>,</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>                              <span class="at">folds =</span> <span class="dv">5</span>,</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>                              <span class="at">parallel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>                              <span class="at">ncores =</span> <span class="dv">2</span>,</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>                              <span class="at">random_seed =</span> <span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="nn-k-fold-cross-validation" class="section level2">
<h2>NN: K-Fold cross-validation</h2>
<p>Example of K-Fold cross-validation (CV) for the NN model.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>resurv_cv_nn <span class="ot">&lt;-</span> <span class="fu">ReSurvCV</span>(<span class="at">IndividualDataPP =</span> individual_data,</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>                         <span class="at">model =</span> <span class="st">&quot;NN&quot;</span>,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>                         <span class="at">hparameters_grid =</span> <span class="fu">list</span>(<span class="at">num_layers =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>                                                 <span class="at">num_nodes =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>                                                 <span class="at">optim =</span> <span class="st">&quot;Adam&quot;</span>,</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>                                                 <span class="at">activation =</span> <span class="st">&quot;ReLU&quot;</span>,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>                                                 <span class="at">lr =</span> .<span class="dv">5</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>                                                 <span class="at">xi =</span> .<span class="dv">5</span>,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>                                                 <span class="at">eps =</span> .<span class="dv">5</span>,</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>                                                 <span class="at">tie =</span> <span class="st">&quot;Efron&quot;</span>,</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>                                                 <span class="at">batch_size =</span> <span class="fu">as.integer</span>(<span class="dv">5000</span>),</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>                                                 <span class="at">early_stopping =</span> <span class="st">&quot;TRUE&quot;</span>,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>                                                 <span class="at">patience =</span> <span class="dv">20</span>),</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>                         <span class="at">epochs =</span> <span class="fu">as.integer</span>(<span class="dv">300</span>),</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>                         <span class="at">num_workers =</span> <span class="dv">0</span>,</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>                         <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>                         <span class="at">verbose.cv =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>                         <span class="at">folds =</span> <span class="dv">3</span>,</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>                         <span class="at">parallel =</span> <span class="cn">FALSE</span>,</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>                         <span class="at">random_seed =</span> <span class="fu">as.integer</span>(<span class="fu">Sys.time</span>()))</span></code></pre></div>
</div>
<div id="resurv-and-bayesian-parameters-optimisation" class="section level2">
<h2>ReSurv and Bayesian Parameters Optimisation</h2>
<div id="xgb-bayesian-parameters-optimisation" class="section level3">
<h3>XGB: Bayesian Parameters Optimisation</h3>
<p>Example of Bayesian Optimization of Hyperparameters for the XGB
model.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">eta =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>               <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="dt">L</span>, <span class="dv">25</span><span class="dt">L</span>),</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>               <span class="at">min_child_weight =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>),</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>               <span class="at">subsample =</span> <span class="fu">c</span>(<span class="fl">0.51</span>, <span class="dv">1</span>),</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>               <span class="at">lambda =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>),</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>))</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>obj_func <span class="ot">&lt;-</span> <span class="cf">function</span>(eta,</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>                     max_depth,</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>                     min_child_weight,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>                     subsample,</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>                     lambda,</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>                     alpha) {</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  xgbcv <span class="ot">&lt;-</span> <span class="fu">ReSurvCV</span>(</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    <span class="at">IndividualDataPP =</span> individual_data,</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">&quot;XGB&quot;</span>,</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    <span class="at">hparameters_grid =</span> <span class="fu">list</span>(</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>      <span class="at">booster =</span> <span class="st">&quot;gbtree&quot;</span>,</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>      <span class="at">eta =</span> eta,</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>      <span class="at">max_depth =</span> max_depth,</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>      <span class="at">subsample =</span> subsample,</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>      <span class="at">alpha =</span> lambda,</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>      <span class="at">lambda =</span> alpha,</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>      <span class="at">min_child_weight =</span> min_child_weight</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>    ),</span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>    <span class="at">print_every_n =</span> <span class="dv">1</span><span class="dt">L</span>,</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>    <span class="at">nrounds =</span> <span class="dv">500</span>,</span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>    <span class="at">verbose.cv =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>    <span class="at">early_stopping_rounds =</span> <span class="dv">30</span>,</span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>    <span class="at">folds =</span> <span class="dv">3</span>,</span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>    <span class="at">parallel =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>    <span class="at">random_seed =</span> <span class="fu">as.integer</span>(<span class="fu">Sys.time</span>())</span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>  )</span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>  lst <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Score =</span> <span class="sc">-</span>xgbcv<span class="sc">$</span>out.cv.best.oos<span class="sc">$</span>test.lkh,</span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>              <span class="at">train.lkh =</span> xgbcv<span class="sc">$</span>out.cv.best.oos<span class="sc">$</span>train.lkh)</span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>  <span class="fu">return</span>(lst)</span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>}</span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>bayes_out <span class="ot">&lt;-</span> <span class="fu">bayesOpt</span>(<span class="at">FUN =</span> obj_func,</span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a>                      <span class="at">bounds =</span> bounds,</span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a>                      <span class="at">initPoints =</span> <span class="dv">50</span>,</span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a>                      <span class="at">iters.n =</span> <span class="dv">1000</span>,</span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>                      <span class="at">iters.k =</span> <span class="dv">50</span>,</span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>                      <span class="at">otherHalting =</span> <span class="fu">list</span>(<span class="at">timeLimit =</span> <span class="dv">18000</span>))</span></code></pre></div>
</div>
<div id="nn-bayesian-parameters-optimisation" class="section level3">
<h3>NN: Bayesian Parameters Optimisation</h3>
<p>Example of Bayesian Optimization of Hyperparameters for the XGB
model.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">num_layers =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="dt">L</span>, <span class="dv">10</span><span class="dt">L</span>),</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>               <span class="at">num_nodes =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="dt">L</span>, <span class="dv">10</span><span class="dt">L</span>),</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>               <span class="at">optim =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="dt">L</span>, <span class="dv">2</span><span class="dt">L</span>),</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>               <span class="at">activation =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="dt">L</span>, <span class="dv">2</span><span class="dt">L</span>),</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>               <span class="at">lr =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.5</span>),</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>               <span class="at">xi =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>               <span class="at">eps =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>))</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>obj_func <span class="ot">&lt;-</span> <span class="cf">function</span>(num_layers,</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>                     num_nodes,</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>                     optim,</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>                     activation,</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>                     lr,</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>                     xi,</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>                     eps) {</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  optim <span class="ot">&lt;-</span> <span class="cf">switch</span>(optim,</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>                  <span class="st">&quot;Adam&quot;</span>,</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>                  <span class="st">&quot;SGD&quot;</span>)</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>  activation <span class="ot">&lt;-</span> <span class="cf">switch</span>(activation, <span class="st">&quot;LeakyReLU&quot;</span>, <span class="st">&quot;SELU&quot;</span>)</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>  batch_size <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="dv">5000</span><span class="dt">L</span>)</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>  number_layers <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(num_layers)</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>  num_nodes <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(num_nodes)</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>  deepsurv_cv <span class="ot">&lt;-</span> <span class="fu">ReSurvCV</span>(<span class="at">IndividualData =</span> individual_data,</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>                          <span class="at">model =</span> <span class="st">&quot;NN&quot;</span>,</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>                          <span class="at">hparameters_grid =</span> <span class="fu">list</span>(<span class="at">num_layers =</span> number_layers,</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>                                                  <span class="at">num_nodes =</span> num_nodes,</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>                                                  <span class="at">optim =</span> optim,</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>                                                  <span class="at">activation =</span> activation,</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>                                                  <span class="at">lr =</span> lr,</span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>                                                  <span class="at">xi =</span> xi,</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>                                                  <span class="at">eps =</span> eps,</span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>                                                  <span class="at">tie =</span> <span class="st">&quot;Efron&quot;</span>,</span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>                                                  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>                                                  <span class="at">early_stopping =</span> <span class="st">&quot;TRUE&quot;</span>,</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>                                                  <span class="at">patience  =</span> <span class="dv">20</span>),</span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>                          <span class="at">epochs =</span> <span class="fu">as.integer</span>(<span class="dv">300</span>),</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>                          <span class="at">num_workers =</span> <span class="dv">0</span>,</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>                          <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>                          <span class="at">verbose.cv =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a>                          <span class="at">folds =</span> <span class="dv">3</span>,</span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a>                          <span class="at">parallel =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a>                          <span class="at">random_seed =</span> <span class="fu">as.integer</span>(<span class="fu">Sys.time</span>()))</span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a>  lst <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Score =</span> <span class="sc">-</span>deepsurv_cv<span class="sc">$</span>out.cv.best.oos<span class="sc">$</span>test.lkh,</span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a>              <span class="at">train.lkh =</span> deepsurv_cv<span class="sc">$</span>out.cv.best.oos<span class="sc">$</span>train.lkh)</span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>  <span class="fu">return</span>(lst)</span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a>}</span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>bayes_out <span class="ot">&lt;-</span> <span class="fu">bayesOpt</span>(<span class="at">FUN =</span> obj_func,</span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>                      <span class="at">bounds =</span> bounds,</span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>                      <span class="at">initPoints =</span> <span class="dv">50</span>,</span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a>                      <span class="at">iters.n =</span> <span class="dv">1000</span>,</span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a>                      <span class="at">iters.k =</span> <span class="dv">50</span>,</span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>                      <span class="at">otherHalting =</span> <span class="fu">list</span>(<span class="at">timeLimit =</span> <span class="dv">18000</span>))</span></code></pre></div>
</div>
</div>
</div>
<div id="estimation" class="section level1">
<h1>Estimation</h1>
<p>In this Section we show the usage of the <code>ReSurv</code> method
for the estimation of our models parameters. The hyperparameters for NN
and XGB were derived with the Bayesian Optimisation procedure.</p>
<div id="cox" class="section level2">
<h2>COX</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>resurv_fit_cox <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>                     <span class="at">hazard_model =</span> <span class="st">&quot;COX&quot;</span>)</span></code></pre></div>
</div>
<div id="xgb" class="section level2">
<h2>XGB</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>hparameters_xgb <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="at">booster =</span> <span class="st">&quot;gbtree&quot;</span>,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fl">0.9611239</span>,</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    <span class="at">subsample =</span> <span class="fl">0.62851</span>,</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">5.836211</span>,</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="dv">15</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="at">min_child_weight =</span> <span class="fl">29.18158</span>,</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="dv">1</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  ),</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="at">print_every_n =</span> <span class="dv">0</span>,</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>  <span class="at">nrounds =</span> <span class="dv">3000</span>,</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  <span class="at">early_stopping_rounds =</span> <span class="dv">500</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>)</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>resurv_fit_xgb <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>                         <span class="at">hazard_model =</span> <span class="st">&quot;XGB&quot;</span>,</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>                         <span class="at">hparameters =</span> hparameters_xgb)</span></code></pre></div>
</div>
<div id="nn" class="section level2">
<h2>NN</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>hparameters_nn <span class="ot">=</span> <span class="fu">list</span>(<span class="at">num_layers=</span> <span class="dv">2</span>,</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>            <span class="at">early_stopping=</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>            <span class="at">patience=</span><span class="dv">350</span>,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>            <span class="at">verbose=</span><span class="cn">FALSE</span>,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>            <span class="at">network_structure=</span><span class="cn">NULL</span>,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>            <span class="at">num_nodes=</span> <span class="dv">10</span>,</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>            <span class="at">activation =</span><span class="st">&quot;LeakyReLU&quot;</span>,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>            <span class="at">optim =</span><span class="st">&quot;SGD&quot;</span>,</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>            <span class="at">lr =</span><span class="fl">0.02226655</span>,</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>            <span class="at">xi=</span><span class="fl">0.4678993</span>,</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>            <span class="at">epsilon=</span> <span class="dv">0</span>,</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>            <span class="at">batch_size=</span> <span class="dv">5000</span><span class="dt">L</span>,</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>            <span class="at">epochs=</span> <span class="dv">5500</span><span class="dt">L</span>,</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>            <span class="at">num_workers=</span> <span class="dv">0</span>,</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>            <span class="at">tie=</span><span class="st">&quot;Efron&quot;</span> )</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>resurv_fit_nn <span class="ot">&lt;-</span> <span class="fu">ReSurv</span>(individual_data,</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>                     <span class="at">hazard_model =</span> <span class="st">&quot;NN&quot;</span>,</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>                     <span class="at">hparameters =</span> hparameters_nn)</span></code></pre></div>
</div>
</div>
<div id="prediction" class="section level1">
<h1>Prediction</h1>
<p>In this Section we show how to use our models for predictions with
the <code>predict</code> method and for different output time
granularities (quarterly, yearly and monthly). The output can be
displayed using the methods <code>summary</code> and
<code>print</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>resurv_fit_predict_q <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit_cox)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>individual_data_y <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(input_data,</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>                                      <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>                                      <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>                                      <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>                                      <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>                                      <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>                                      <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>                                      <span class="at">output_time_granularity =</span> <span class="st">&quot;years&quot;</span>,</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>                                      <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>                                      <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>                                      <span class="at">calendar_period_extrapolation =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>resurv_fit_predict_y <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit_cox,</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>                                <span class="at">newdata =</span> individual_data_y,</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>                                <span class="at">grouping_method =</span> <span class="st">&quot;probability&quot;</span>)</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>individual_data_m <span class="ot">&lt;-</span> <span class="fu">IndividualDataPP</span>(input_data,</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>                                      <span class="at">id =</span> <span class="st">&quot;claim_number&quot;</span>,</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>                                      <span class="at">continuous_features =</span> <span class="st">&quot;AP_i&quot;</span>,</span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>                                      <span class="at">categorical_features =</span> <span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>                                      <span class="at">accident_period =</span> <span class="st">&quot;AP&quot;</span>,</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>                                      <span class="at">calendar_period =</span> <span class="st">&quot;RP&quot;</span>,</span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>                                      <span class="at">input_time_granularity =</span> <span class="st">&quot;days&quot;</span>,</span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>                                      <span class="at">output_time_granularity =</span> <span class="st">&quot;months&quot;</span>,</span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>                                      <span class="at">years =</span> <span class="dv">4</span>,</span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>                                      <span class="at">continuous_features_spline =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>                                      <span class="at">calendar_period_extrapolation =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a>resurv_fit_predict_m <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit_cox,</span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a>                                <span class="at">newdata =</span> individual_data_m,</span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>                                <span class="at">grouping_method =</span> <span class="st">&quot;probability&quot;</span>)</span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a>model_s <span class="ot">&lt;-</span> <span class="fu">summary</span>(resurv_fit_predict_y)</span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a><span class="fu">print</span>(model_s)</span></code></pre></div>
<p>Similar functions for the other models</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>resurv_predict_xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit_xgb)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>resurv_predict_nn <span class="ot">&lt;-</span> <span class="fu">predict</span>(resurv_fit_nn)</span></code></pre></div>
</div>
<div id="plot-the-predicted-development-factors" class="section level1">
<h1>Plot the predicted development factors</h1>
<p>In this Section we show an example of development factors plot for
the COX model.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>resurv_fit_predict_q<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="fu">filter</span>(AP_o<span class="sc">==</span><span class="dv">15</span> <span class="sc">&amp;</span> claim_type <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="fu">select</span>(group_o)</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="fu">plot</span>(resurv_fit_predict_q, </span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>         <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>         <span class="at">title_par =</span> <span class="st">&quot;COX: Accident Quarter 15 Claim Type 1&quot;</span>,</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>         <span class="at">group_code =</span> <span class="dv">30</span>)</span></code></pre></div>
</div>
<div id="crps" class="section level1">
<h1>CRPS</h1>
<p>In this Section we show the CRPS calculation using the
<code>survival_crps</code> method.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>crps <span class="ot">&lt;-</span> <span class="fu">survival_crps</span>(resurv_fit_cox)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>m_crps <span class="ot">&lt;-</span> <span class="fu">mean</span>(crps<span class="sc">$</span>crps)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>m_crps</span></code></pre></div>
</div>
<div id="plot-the-development-factors" class="section level1">
<h1>Plot the development factors</h1>
<p>We first extract the output group code for an arbitrary group.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>resurv_fit_predict_q<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>    <span class="fu">filter</span>(AP_o<span class="sc">==</span><span class="dv">15</span> <span class="sc">&amp;</span> claim_type <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    <span class="fu">select</span>(group_o)</span></code></pre></div>
<p>We use the group code to plot the feature dependent development
factors.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">plot</span>(resurv_fit_predict_q, </span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>         <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>         <span class="at">title_par =</span> <span class="st">&quot;COX: Accident Quarter 15 Claim Type 1&quot;</span>,</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>         <span class="at">group_code =</span> <span class="dv">30</span>)</span></code></pre></div>
</div>
<div id="appendix" class="section level1">
<h1>Appendix</h1>
<div id="code-to-replicate-figure-1" class="section level2">
<h2>Code to replicate Figure 1</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> input_data <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.factor</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> RT <span class="sc">-</span> AT, <span class="at">color =</span> claim_type)) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Notification delay (in days)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ECDF&quot;</span>) <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fl">0.01</span>, <span class="dv">1500</span>) <span class="sc">+</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;royalblue&quot;</span>, <span class="st">&quot;#a71429&quot;</span>),</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Claim type 0&quot;</span>, <span class="st">&quot;Claim type 1&quot;</span>)</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Claim type 0&quot;</span>, <span class="st">&quot;Claim type 1&quot;</span>)) <span class="sc">+</span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Claim type&quot;</span>,</span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>      <span class="at">override.aes =</span> <span class="fu">list</span>(</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>        <span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;royalblue&quot;</span>, <span class="st">&quot;#a71429&quot;</span>),</span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="dv">2</span></span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>      )</span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>    ),</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Claim type&quot;</span>,</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>      <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">linetype =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">linewidth =</span> <span class="fl">0.7</span>)</span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a>    )</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a>    <span class="at">axis.title.x  =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)</span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a>  )</span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a>p1</span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> input_data <span class="sc">%&gt;%</span></span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.factor</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> claim_type, <span class="at">fill =</span> claim_type)) <span class="sc">+</span></span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;royalblue&quot;</span>, <span class="st">&quot;#a71429&quot;</span>),</span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Claim type 0&quot;</span>, <span class="st">&quot;Claim type 1&quot;</span>)</span>
<span id="cb22-45"><a href="#cb22-45" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-46"><a href="#cb22-46" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">&quot;Claim type&quot;</span>)) <span class="sc">+</span></span>
<span id="cb22-47"><a href="#cb22-47" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb22-48"><a href="#cb22-48" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Claim Type&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb22-49"><a href="#cb22-49" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-50"><a href="#cb22-50" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb22-51"><a href="#cb22-51" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb22-52"><a href="#cb22-52" tabindex="-1"></a>    <span class="at">axis.title.x  =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb22-53"><a href="#cb22-53" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)</span>
<span id="cb22-54"><a href="#cb22-54" tabindex="-1"></a>  )</span>
<span id="cb22-55"><a href="#cb22-55" tabindex="-1"></a>p2</span></code></pre></div>
</div>
<div id="code-for-plotting-feature-dependent-development-factors" class="section level2">
<h2>Code for plotting feature-dependent development factors</h2>
<p>Chain-Ladder case.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>clmodel <span class="ot">&lt;-</span> resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="dv">16</span> <span class="sc">-</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>           DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="fu">arrange</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I), <span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>  <span class="fu">group_by</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">df_o =</span> <span class="fu">sum</span>(I_cum <span class="sc">*</span> (</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>      <span class="dv">1</span></span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>  )) <span class="sc">/</span></span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>    <span class="fu">sum</span>(I_cum_lag <span class="sc">*</span> (</span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>      AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a>        <span class="dv">1</span></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a>    )),</span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>  <span class="at">I =</span> <span class="fu">sum</span>(I <span class="sc">*</span> (</span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o</span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o_join =</span> DP_o <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a>clmodel <span class="sc">%&gt;%</span></span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a>  <span class="fu">filter</span>(DP_o <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DP_o, <span class="at">y =</span> df_o)) <span class="sc">+</span></span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">2.5</span>,</span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;#454555&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Chain ladder&quot;</span>,</span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Development quarter&quot;</span>,</span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Development factor&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="fl">3.</span> <span class="sc">+</span> .<span class="dv">01</span>) <span class="sc">+</span></span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="fu">rel</span>(<span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>))</span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a></span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb23-39"><a href="#cb23-39" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" tabindex="-1"></a>clmodel_months <span class="ot">&lt;-</span> individual_data_m<span class="sc">$</span>training.data <span class="sc">%&gt;%</span></span>
<span id="cb23-41"><a href="#cb23-41" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="dv">48</span> <span class="sc">-</span></span>
<span id="cb23-42"><a href="#cb23-42" tabindex="-1"></a>           DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-43"><a href="#cb23-43" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-44"><a href="#cb23-44" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-45"><a href="#cb23-45" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-46"><a href="#cb23-46" tabindex="-1"></a>  <span class="fu">arrange</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-47"><a href="#cb23-47" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I), <span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-48"><a href="#cb23-48" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-49"><a href="#cb23-49" tabindex="-1"></a>  <span class="fu">group_by</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-50"><a href="#cb23-50" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">df_o =</span> <span class="fu">sum</span>(I_cum <span class="sc">*</span> (</span>
<span id="cb23-51"><a href="#cb23-51" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb23-52"><a href="#cb23-52" tabindex="-1"></a>  )) <span class="sc">/</span></span>
<span id="cb23-53"><a href="#cb23-53" tabindex="-1"></a>    <span class="fu">sum</span>(I_cum_lag <span class="sc">*</span> (</span>
<span id="cb23-54"><a href="#cb23-54" tabindex="-1"></a>      AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb23-55"><a href="#cb23-55" tabindex="-1"></a>    )),</span>
<span id="cb23-56"><a href="#cb23-56" tabindex="-1"></a>  <span class="at">I =</span> <span class="fu">sum</span>(I <span class="sc">*</span> (</span>
<span id="cb23-57"><a href="#cb23-57" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o</span>
<span id="cb23-58"><a href="#cb23-58" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb23-59"><a href="#cb23-59" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o_join =</span> DP_o <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-60"><a href="#cb23-60" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb23-61"><a href="#cb23-61" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" tabindex="-1"></a>ticks_at <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">48</span>, <span class="dv">4</span>)</span>
<span id="cb23-63"><a href="#cb23-63" tabindex="-1"></a>labels_as <span class="ot">&lt;-</span> <span class="fu">as.character</span>(ticks_at)</span>
<span id="cb23-64"><a href="#cb23-64" tabindex="-1"></a></span>
<span id="cb23-65"><a href="#cb23-65" tabindex="-1"></a>clmodel_months <span class="sc">%&gt;%</span></span>
<span id="cb23-66"><a href="#cb23-66" tabindex="-1"></a>  <span class="fu">filter</span>(DP_o <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-67"><a href="#cb23-67" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DP_o,</span>
<span id="cb23-68"><a href="#cb23-68" tabindex="-1"></a>             <span class="at">y =</span> df_o)) <span class="sc">+</span></span>
<span id="cb23-69"><a href="#cb23-69" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">2.5</span>,</span>
<span id="cb23-70"><a href="#cb23-70" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;#454555&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-71"><a href="#cb23-71" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Chain ladder&quot;</span>,</span>
<span id="cb23-72"><a href="#cb23-72" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Development month&quot;</span>,</span>
<span id="cb23-73"><a href="#cb23-73" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Development factor&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-74"><a href="#cb23-74" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="fl">2.5</span> <span class="sc">+</span> .<span class="dv">01</span>) <span class="sc">+</span></span>
<span id="cb23-75"><a href="#cb23-75" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> ticks_at, <span class="at">labels =</span> labels_as) <span class="sc">+</span></span>
<span id="cb23-76"><a href="#cb23-76" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="fu">rel</span>(<span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb23-77"><a href="#cb23-77" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>))</span>
<span id="cb23-78"><a href="#cb23-78" tabindex="-1"></a></span>
<span id="cb23-79"><a href="#cb23-79" tabindex="-1"></a></span>
<span id="cb23-80"><a href="#cb23-80" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb23-81"><a href="#cb23-81" tabindex="-1"></a></span>
<span id="cb23-82"><a href="#cb23-82" tabindex="-1"></a>clmodel_years <span class="ot">&lt;-</span> individual_data_y<span class="sc">$</span>training.data <span class="sc">%&gt;%</span></span>
<span id="cb23-83"><a href="#cb23-83" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="dv">4</span> <span class="sc">-</span></span>
<span id="cb23-84"><a href="#cb23-84" tabindex="-1"></a>           DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-85"><a href="#cb23-85" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-86"><a href="#cb23-86" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-87"><a href="#cb23-87" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-88"><a href="#cb23-88" tabindex="-1"></a>  <span class="fu">arrange</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-89"><a href="#cb23-89" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I), <span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-90"><a href="#cb23-90" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-91"><a href="#cb23-91" tabindex="-1"></a>  <span class="fu">group_by</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb23-92"><a href="#cb23-92" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">df_o =</span> <span class="fu">sum</span>(I_cum <span class="sc">*</span> (</span>
<span id="cb23-93"><a href="#cb23-93" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb23-94"><a href="#cb23-94" tabindex="-1"></a>  )) <span class="sc">/</span></span>
<span id="cb23-95"><a href="#cb23-95" tabindex="-1"></a>    <span class="fu">sum</span>(I_cum_lag <span class="sc">*</span> (</span>
<span id="cb23-96"><a href="#cb23-96" tabindex="-1"></a>      AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb23-97"><a href="#cb23-97" tabindex="-1"></a>    )),</span>
<span id="cb23-98"><a href="#cb23-98" tabindex="-1"></a>  <span class="at">I =</span> <span class="fu">sum</span>(I <span class="sc">*</span> (</span>
<span id="cb23-99"><a href="#cb23-99" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data_m<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o</span>
<span id="cb23-100"><a href="#cb23-100" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb23-101"><a href="#cb23-101" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o_join =</span> DP_o <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-102"><a href="#cb23-102" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb23-103"><a href="#cb23-103" tabindex="-1"></a></span>
<span id="cb23-104"><a href="#cb23-104" tabindex="-1"></a>ticks_at <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>)</span>
<span id="cb23-105"><a href="#cb23-105" tabindex="-1"></a>labels_as <span class="ot">&lt;-</span> <span class="fu">as.character</span>(ticks_at)</span>
<span id="cb23-106"><a href="#cb23-106" tabindex="-1"></a></span>
<span id="cb23-107"><a href="#cb23-107" tabindex="-1"></a>clmodel_years <span class="sc">%&gt;%</span></span>
<span id="cb23-108"><a href="#cb23-108" tabindex="-1"></a>  <span class="fu">filter</span>(DP_o <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-109"><a href="#cb23-109" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DP_o,</span>
<span id="cb23-110"><a href="#cb23-110" tabindex="-1"></a>             <span class="at">y =</span> df_o)) <span class="sc">+</span></span>
<span id="cb23-111"><a href="#cb23-111" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">2.5</span>,</span>
<span id="cb23-112"><a href="#cb23-112" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;#454555&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-113"><a href="#cb23-113" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Chain ladder&quot;</span>,</span>
<span id="cb23-114"><a href="#cb23-114" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Development year&quot;</span>,</span>
<span id="cb23-115"><a href="#cb23-115" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Development factor&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-116"><a href="#cb23-116" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="fl">2.5</span> <span class="sc">+</span> .<span class="dv">01</span>) <span class="sc">+</span></span>
<span id="cb23-117"><a href="#cb23-117" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> ticks_at, <span class="at">labels =</span> labels_as) <span class="sc">+</span></span>
<span id="cb23-118"><a href="#cb23-118" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="fu">rel</span>(<span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb23-119"><a href="#cb23-119" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>))</span></code></pre></div>
<p>COX, quarterly output.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>resurv_fit_predict_q<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>  resurv_fit_predict_q,</span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;COX: Accident Quarter 12 Claim Type 0&quot;</span>,</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">23</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>)</span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">36</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>resurv_fit_predict_m<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a>  resurv_fit_predict_m,</span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>  <span class="at">color_par =</span> <span class="st">&quot;#a71429&quot;</span>,</span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;COX: Accident Month 36 Claim Type 0&quot;</span>,</span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">71</span></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a>)</span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a>resurv_fit_predict_m<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb24-39"><a href="#cb24-39" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb24-40"><a href="#cb24-40" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-41"><a href="#cb24-41" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb24-42"><a href="#cb24-42" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb24-44"><a href="#cb24-44" tabindex="-1"></a>  resurv_fit_predict_m,</span>
<span id="cb24-45"><a href="#cb24-45" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb24-46"><a href="#cb24-46" tabindex="-1"></a>  <span class="at">color_par =</span> <span class="st">&quot;#a71429&quot;</span>,</span>
<span id="cb24-47"><a href="#cb24-47" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;COX: Accident Month 7 Claim Type 1&quot;</span>,</span>
<span id="cb24-48"><a href="#cb24-48" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">14</span></span>
<span id="cb24-49"><a href="#cb24-49" tabindex="-1"></a>)</span>
<span id="cb24-50"><a href="#cb24-50" tabindex="-1"></a></span>
<span id="cb24-51"><a href="#cb24-51" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-53"><a href="#cb24-53" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb24-54"><a href="#cb24-54" tabindex="-1"></a></span>
<span id="cb24-55"><a href="#cb24-55" tabindex="-1"></a>resurv_fit_predict_y<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb24-56"><a href="#cb24-56" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb24-57"><a href="#cb24-57" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-58"><a href="#cb24-58" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb24-59"><a href="#cb24-59" tabindex="-1"></a></span>
<span id="cb24-60"><a href="#cb24-60" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb24-61"><a href="#cb24-61" tabindex="-1"></a>  resurv_fit_predict_y,</span>
<span id="cb24-62"><a href="#cb24-62" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb24-63"><a href="#cb24-63" tabindex="-1"></a>  <span class="at">color_par =</span> <span class="st">&quot;#FF6A7A&quot;</span>,</span>
<span id="cb24-64"><a href="#cb24-64" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;COX: Accident Year 2 Claim Type 0&quot;</span>,</span>
<span id="cb24-65"><a href="#cb24-65" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">3</span></span>
<span id="cb24-66"><a href="#cb24-66" tabindex="-1"></a>)</span>
<span id="cb24-67"><a href="#cb24-67" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb24-70"><a href="#cb24-70" tabindex="-1"></a>ap <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb24-71"><a href="#cb24-71" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" tabindex="-1"></a>resurv_fit_predict_y<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity <span class="sc">%&gt;%</span></span>
<span id="cb24-73"><a href="#cb24-73" tabindex="-1"></a>  <span class="fu">filter</span>(AP_o <span class="sc">==</span> ap <span class="sc">&amp;</span> claim_type <span class="sc">==</span> ct) <span class="sc">%&gt;%</span></span>
<span id="cb24-74"><a href="#cb24-74" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-75"><a href="#cb24-75" tabindex="-1"></a>  <span class="fu">select</span>(group_o)</span>
<span id="cb24-76"><a href="#cb24-76" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb24-79"><a href="#cb24-79" tabindex="-1"></a>  resurv_fit_predict_y,</span>
<span id="cb24-80"><a href="#cb24-80" tabindex="-1"></a>  <span class="at">granularity =</span> <span class="st">&quot;output&quot;</span>,</span>
<span id="cb24-81"><a href="#cb24-81" tabindex="-1"></a>  <span class="at">color_par =</span> <span class="st">&quot;#FF6A7A&quot;</span>,</span>
<span id="cb24-82"><a href="#cb24-82" tabindex="-1"></a>  <span class="at">title_par =</span> <span class="st">&quot;COX: Accident Year 3 Claim Type 1&quot;</span>,</span>
<span id="cb24-83"><a href="#cb24-83" tabindex="-1"></a>  <span class="at">group_code =</span> <span class="dv">6</span></span>
<span id="cb24-84"><a href="#cb24-84" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="code-for-computing-are-tot-and-are-cal" class="section level2">
<h2>Code for computing ARE TOT and ARE CAL</h2>
<p>The code below can be used to compute the performance metrics in
Table 6 of the manuscript.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>conversion_factor <span class="ot">&lt;-</span> individual_data<span class="sc">$</span>conversion_factor</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>max_dp_i <span class="ot">&lt;-</span> <span class="dv">1440</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>true_output <span class="ot">&lt;-</span> resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>full.data <span class="sc">%&gt;%</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>      <span class="fu">ceiling</span>(</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>              DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor),</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>    <span class="at">TR_o =</span> AP_o <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&lt;=</span> TR_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>out_list <span class="ot">&lt;-</span> resurv_fit_predict_q<span class="sc">$</span>long_triangle_format_out</span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>out <span class="ot">&lt;-</span> out_list<span class="sc">$</span>output_granularity</span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a><span class="co">#Total output</span></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a>score_total <span class="ot">&lt;-</span> out[, <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_o&quot;</span>, <span class="st">&quot;expected_counts&quot;</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ave =</span> I <span class="sc">-</span> expected_counts, <span class="at">abs_ave =</span> <span class="fu">abs</span>(ave)) <span class="sc">%&gt;%</span></span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a>  <span class="co"># from here it is reformulated for the are tot</span></span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(ave)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a>are_tot <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>abs_ave) <span class="sc">/</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>I)</span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" tabindex="-1"></a>dfs_output <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span></span>
<span id="cb25-39"><a href="#cb25-39" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-40"><a href="#cb25-40" tabindex="-1"></a>  <span class="fu">select</span>(AP_o, claim_type, DP_rev_o, f_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-41"><a href="#cb25-41" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-42"><a href="#cb25-42" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb25-43"><a href="#cb25-43" tabindex="-1"></a></span>
<span id="cb25-44"><a href="#cb25-44" tabindex="-1"></a><span class="co">#Cashflow on output scale.Etc quarterly cashflow development</span></span>
<span id="cb25-45"><a href="#cb25-45" tabindex="-1"></a>score_diagonal <span class="ot">&lt;-</span> resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>full.data  <span class="sc">%&gt;%</span></span>
<span id="cb25-46"><a href="#cb25-46" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-47"><a href="#cb25-47" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb25-48"><a href="#cb25-48" tabindex="-1"></a>      <span class="fu">ceiling</span>(</span>
<span id="cb25-49"><a href="#cb25-49" tabindex="-1"></a>              DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb25-50"><a href="#cb25-50" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb25-51"><a href="#cb25-51" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb25-52"><a href="#cb25-52" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb25-53"><a href="#cb25-53" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor)</span>
<span id="cb25-54"><a href="#cb25-54" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-55"><a href="#cb25-55" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-56"><a href="#cb25-56" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb25-57"><a href="#cb25-57" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-58"><a href="#cb25-58" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-59"><a href="#cb25-59" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(DP_rev_o)) <span class="sc">%&gt;%</span></span>
<span id="cb25-60"><a href="#cb25-60" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I)) <span class="sc">%&gt;%</span></span>
<span id="cb25-61"><a href="#cb25-61" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-62"><a href="#cb25-62" tabindex="-1"></a>  <span class="fu">left_join</span>(dfs_output, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-63"><a href="#cb25-63" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_hat =</span>  I_cum_lag <span class="sc">*</span> f_o,</span>
<span id="cb25-64"><a href="#cb25-64" tabindex="-1"></a>         <span class="at">RP_o =</span> <span class="fu">max</span>(DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-65"><a href="#cb25-65" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output[, <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)] <span class="sc">%&gt;%</span>  <span class="fu">distinct</span>()</span>
<span id="cb25-66"><a href="#cb25-66" tabindex="-1"></a>             , <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-67"><a href="#cb25-67" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-68"><a href="#cb25-68" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave2_diag =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(I_cum_hat) <span class="sc">-</span> <span class="fu">sum</span>(I_cum)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-69"><a href="#cb25-69" tabindex="-1"></a></span>
<span id="cb25-70"><a href="#cb25-70" tabindex="-1"></a>are_cal_q <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>abs_ave2_diag) <span class="sc">/</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>I)</span>
<span id="cb25-71"><a href="#cb25-71" tabindex="-1"></a></span>
<span id="cb25-72"><a href="#cb25-72" tabindex="-1"></a></span>
<span id="cb25-73"><a href="#cb25-73" tabindex="-1"></a><span class="co"># scoring XGB ----</span></span>
<span id="cb25-74"><a href="#cb25-74" tabindex="-1"></a></span>
<span id="cb25-75"><a href="#cb25-75" tabindex="-1"></a>out_xgb <span class="ot">&lt;-</span> resurv_predict_xgb<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity</span>
<span id="cb25-76"><a href="#cb25-76" tabindex="-1"></a></span>
<span id="cb25-77"><a href="#cb25-77" tabindex="-1"></a>score_total_xgb <span class="ot">&lt;-</span> out_xgb[, <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb25-78"><a href="#cb25-78" tabindex="-1"></a>                               <span class="st">&quot;AP_o&quot;</span>,</span>
<span id="cb25-79"><a href="#cb25-79" tabindex="-1"></a>                               <span class="st">&quot;DP_o&quot;</span>,</span>
<span id="cb25-80"><a href="#cb25-80" tabindex="-1"></a>                               <span class="st">&quot;expected_counts&quot;</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb25-81"><a href="#cb25-81" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-82"><a href="#cb25-82" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-83"><a href="#cb25-83" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ave =</span> I <span class="sc">-</span> expected_counts, <span class="at">abs_ave =</span> <span class="fu">abs</span>(ave)) <span class="sc">%&gt;%</span></span>
<span id="cb25-84"><a href="#cb25-84" tabindex="-1"></a>  <span class="co"># from here it is reformulated for the are tot</span></span>
<span id="cb25-85"><a href="#cb25-85" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-86"><a href="#cb25-86" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-87"><a href="#cb25-87" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(ave)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-88"><a href="#cb25-88" tabindex="-1"></a></span>
<span id="cb25-89"><a href="#cb25-89" tabindex="-1"></a>are_tot_xgb <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_total_xgb<span class="sc">$</span>abs_ave) <span class="sc">/</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>I)</span>
<span id="cb25-90"><a href="#cb25-90" tabindex="-1"></a></span>
<span id="cb25-91"><a href="#cb25-91" tabindex="-1"></a></span>
<span id="cb25-92"><a href="#cb25-92" tabindex="-1"></a>dfs_output_xgb <span class="ot">&lt;-</span> out_xgb <span class="sc">%&gt;%</span></span>
<span id="cb25-93"><a href="#cb25-93" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-94"><a href="#cb25-94" tabindex="-1"></a>  <span class="fu">select</span>(AP_o, claim_type, DP_rev_o, f_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-95"><a href="#cb25-95" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-96"><a href="#cb25-96" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb25-97"><a href="#cb25-97" tabindex="-1"></a></span>
<span id="cb25-98"><a href="#cb25-98" tabindex="-1"></a><span class="co">#Cashflow on output scale.Etc quarterly cashflow development</span></span>
<span id="cb25-99"><a href="#cb25-99" tabindex="-1"></a>score_diagonal_xgb <span class="ot">&lt;-</span> resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>full.data  <span class="sc">%&gt;%</span></span>
<span id="cb25-100"><a href="#cb25-100" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-101"><a href="#cb25-101" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb25-102"><a href="#cb25-102" tabindex="-1"></a>      <span class="fu">ceiling</span>(</span>
<span id="cb25-103"><a href="#cb25-103" tabindex="-1"></a>              DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb25-104"><a href="#cb25-104" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb25-105"><a href="#cb25-105" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb25-106"><a href="#cb25-106" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb25-107"><a href="#cb25-107" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor)</span>
<span id="cb25-108"><a href="#cb25-108" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-109"><a href="#cb25-109" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-110"><a href="#cb25-110" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb25-111"><a href="#cb25-111" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-112"><a href="#cb25-112" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-113"><a href="#cb25-113" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(DP_rev_o)) <span class="sc">%&gt;%</span></span>
<span id="cb25-114"><a href="#cb25-114" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I)) <span class="sc">%&gt;%</span></span>
<span id="cb25-115"><a href="#cb25-115" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-116"><a href="#cb25-116" tabindex="-1"></a>  <span class="fu">left_join</span>(dfs_output_xgb, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-117"><a href="#cb25-117" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_hat =</span>  I_cum_lag <span class="sc">*</span> f_o,</span>
<span id="cb25-118"><a href="#cb25-118" tabindex="-1"></a>         <span class="at">RP_o =</span> <span class="fu">max</span>(DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-119"><a href="#cb25-119" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output[, <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)] <span class="sc">%&gt;%</span>  <span class="fu">distinct</span>()</span>
<span id="cb25-120"><a href="#cb25-120" tabindex="-1"></a>             , <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-121"><a href="#cb25-121" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-122"><a href="#cb25-122" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave2_diag =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(I_cum_hat) <span class="sc">-</span> <span class="fu">sum</span>(I_cum)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-123"><a href="#cb25-123" tabindex="-1"></a></span>
<span id="cb25-124"><a href="#cb25-124" tabindex="-1"></a>are_cal_q_xgb <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_diagonal_xgb<span class="sc">$</span>abs_ave2_diag) <span class="sc">/</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>I)</span>
<span id="cb25-125"><a href="#cb25-125" tabindex="-1"></a></span>
<span id="cb25-126"><a href="#cb25-126" tabindex="-1"></a><span class="co"># scoring NN ----</span></span>
<span id="cb25-127"><a href="#cb25-127" tabindex="-1"></a></span>
<span id="cb25-128"><a href="#cb25-128" tabindex="-1"></a>out_nn <span class="ot">&lt;-</span> resurv_predict_nn<span class="sc">$</span>long_triangle_format_out<span class="sc">$</span>output_granularity</span>
<span id="cb25-129"><a href="#cb25-129" tabindex="-1"></a></span>
<span id="cb25-130"><a href="#cb25-130" tabindex="-1"></a>score_total_nn <span class="ot">&lt;-</span> out_nn[, <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>,</span>
<span id="cb25-131"><a href="#cb25-131" tabindex="-1"></a>                             <span class="st">&quot;AP_o&quot;</span>,</span>
<span id="cb25-132"><a href="#cb25-132" tabindex="-1"></a>                             <span class="st">&quot;DP_o&quot;</span>,</span>
<span id="cb25-133"><a href="#cb25-133" tabindex="-1"></a>                             <span class="st">&quot;expected_counts&quot;</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb25-134"><a href="#cb25-134" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-135"><a href="#cb25-135" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-136"><a href="#cb25-136" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ave =</span> I <span class="sc">-</span> expected_counts, <span class="at">abs_ave =</span> <span class="fu">abs</span>(ave)) <span class="sc">%&gt;%</span></span>
<span id="cb25-137"><a href="#cb25-137" tabindex="-1"></a>  <span class="co"># from here it is reformulated for the are tot</span></span>
<span id="cb25-138"><a href="#cb25-138" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-139"><a href="#cb25-139" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-140"><a href="#cb25-140" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(ave)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-141"><a href="#cb25-141" tabindex="-1"></a></span>
<span id="cb25-142"><a href="#cb25-142" tabindex="-1"></a>are_tot_nn <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_total_nn<span class="sc">$</span>abs_ave) <span class="sc">/</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>I)</span>
<span id="cb25-143"><a href="#cb25-143" tabindex="-1"></a></span>
<span id="cb25-144"><a href="#cb25-144" tabindex="-1"></a></span>
<span id="cb25-145"><a href="#cb25-145" tabindex="-1"></a>dfs_output_nn <span class="ot">&lt;-</span> out_nn <span class="sc">%&gt;%</span></span>
<span id="cb25-146"><a href="#cb25-146" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="dv">16</span> <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-147"><a href="#cb25-147" tabindex="-1"></a>  <span class="fu">select</span>(AP_o, claim_type, DP_rev_o, f_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-148"><a href="#cb25-148" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-149"><a href="#cb25-149" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb25-150"><a href="#cb25-150" tabindex="-1"></a></span>
<span id="cb25-151"><a href="#cb25-151" tabindex="-1"></a><span class="co">#Cashflow on output scale.Etc quarterly cashflow development</span></span>
<span id="cb25-152"><a href="#cb25-152" tabindex="-1"></a>score_diagonal_nn <span class="ot">&lt;-</span> resurv_fit_cox<span class="sc">$</span>IndividualDataPP<span class="sc">$</span>full.data  <span class="sc">%&gt;%</span></span>
<span id="cb25-153"><a href="#cb25-153" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-154"><a href="#cb25-154" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb25-155"><a href="#cb25-155" tabindex="-1"></a>      <span class="fu">ceiling</span>(</span>
<span id="cb25-156"><a href="#cb25-156" tabindex="-1"></a>              DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb25-157"><a href="#cb25-157" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb25-158"><a href="#cb25-158" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb25-159"><a href="#cb25-159" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb25-160"><a href="#cb25-160" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor)</span>
<span id="cb25-161"><a href="#cb25-161" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-162"><a href="#cb25-162" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-163"><a href="#cb25-163" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb25-164"><a href="#cb25-164" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-165"><a href="#cb25-165" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-166"><a href="#cb25-166" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(DP_rev_o)) <span class="sc">%&gt;%</span></span>
<span id="cb25-167"><a href="#cb25-167" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I)) <span class="sc">%&gt;%</span></span>
<span id="cb25-168"><a href="#cb25-168" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-169"><a href="#cb25-169" tabindex="-1"></a>  <span class="fu">left_join</span>(dfs_output_nn, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;claim_type&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-170"><a href="#cb25-170" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_hat =</span>  I_cum_lag <span class="sc">*</span> f_o,</span>
<span id="cb25-171"><a href="#cb25-171" tabindex="-1"></a>         <span class="at">RP_o =</span> <span class="fu">max</span>(DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-172"><a href="#cb25-172" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output[, <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)] <span class="sc">%&gt;%</span>  <span class="fu">distinct</span>()</span>
<span id="cb25-173"><a href="#cb25-173" tabindex="-1"></a>             , <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-174"><a href="#cb25-174" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-175"><a href="#cb25-175" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave2_diag =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(I_cum_hat) <span class="sc">-</span> <span class="fu">sum</span>(I_cum)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-176"><a href="#cb25-176" tabindex="-1"></a></span>
<span id="cb25-177"><a href="#cb25-177" tabindex="-1"></a>are_cal_q_nn <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_diagonal_nn<span class="sc">$</span>abs_ave2_diag) <span class="sc">/</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>I)</span>
<span id="cb25-178"><a href="#cb25-178" tabindex="-1"></a></span>
<span id="cb25-179"><a href="#cb25-179" tabindex="-1"></a><span class="co"># Scoring Chain-Ladder ----</span></span>
<span id="cb25-180"><a href="#cb25-180" tabindex="-1"></a></span>
<span id="cb25-181"><a href="#cb25-181" tabindex="-1"></a>true_output_cl <span class="ot">&lt;-</span> individual_data<span class="sc">$</span>full.data <span class="sc">%&gt;%</span></span>
<span id="cb25-182"><a href="#cb25-182" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-183"><a href="#cb25-183" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb25-184"><a href="#cb25-184" tabindex="-1"></a>      <span class="fu">ceiling</span>(</span>
<span id="cb25-185"><a href="#cb25-185" tabindex="-1"></a>              DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb25-186"><a href="#cb25-186" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb25-187"><a href="#cb25-187" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb25-188"><a href="#cb25-188" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb25-189"><a href="#cb25-189" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor)</span>
<span id="cb25-190"><a href="#cb25-190" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-191"><a href="#cb25-191" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&lt;=</span> TR_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-192"><a href="#cb25-192" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="fu">max</span>(individual_data<span class="sc">$</span>training.data<span class="sc">$</span>DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-193"><a href="#cb25-193" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-194"><a href="#cb25-194" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-195"><a href="#cb25-195" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb25-196"><a href="#cb25-196" tabindex="-1"></a>latest_observed <span class="ot">&lt;-</span> individual_data<span class="sc">$</span>training.data <span class="sc">%&gt;%</span></span>
<span id="cb25-197"><a href="#cb25-197" tabindex="-1"></a>  <span class="fu">filter</span>(DP_rev_o <span class="sc">&gt;=</span> TR_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-198"><a href="#cb25-198" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="fu">max</span>(individual_data<span class="sc">$</span>training.data<span class="sc">$</span>DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-199"><a href="#cb25-199" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-200"><a href="#cb25-200" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_max =</span> <span class="fu">max</span>(DP_o)) <span class="sc">%&gt;%</span></span>
<span id="cb25-201"><a href="#cb25-201" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_max) <span class="sc">%&gt;%</span></span>
<span id="cb25-202"><a href="#cb25-202" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb25-203"><a href="#cb25-203" tabindex="-1"></a></span>
<span id="cb25-204"><a href="#cb25-204" tabindex="-1"></a>clmodel <span class="ot">&lt;-</span> individual_data<span class="sc">$</span>training.data <span class="sc">%&gt;%</span></span>
<span id="cb25-205"><a href="#cb25-205" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="fu">max</span>(individual_data<span class="sc">$</span>training.data<span class="sc">$</span>DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-206"><a href="#cb25-206" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-207"><a href="#cb25-207" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-208"><a href="#cb25-208" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-209"><a href="#cb25-209" tabindex="-1"></a>  <span class="fu">arrange</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-210"><a href="#cb25-210" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I), <span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-211"><a href="#cb25-211" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-212"><a href="#cb25-212" tabindex="-1"></a>  <span class="fu">group_by</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-213"><a href="#cb25-213" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">df =</span> <span class="fu">sum</span>(I_cum <span class="sc">*</span> (</span>
<span id="cb25-214"><a href="#cb25-214" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb25-215"><a href="#cb25-215" tabindex="-1"></a>  )) <span class="sc">/</span></span>
<span id="cb25-216"><a href="#cb25-216" tabindex="-1"></a>    <span class="fu">sum</span>(I_cum_lag <span class="sc">*</span> (</span>
<span id="cb25-217"><a href="#cb25-217" tabindex="-1"></a>      AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb25-218"><a href="#cb25-218" tabindex="-1"></a>    )), <span class="at">I =</span> <span class="fu">sum</span>(I <span class="sc">*</span> (</span>
<span id="cb25-219"><a href="#cb25-219" tabindex="-1"></a>    AP_o <span class="sc">&lt;=</span> <span class="fu">max</span>(individual_data<span class="sc">$</span>training.data<span class="sc">$</span>AP_o) <span class="sc">-</span> DP_o</span>
<span id="cb25-220"><a href="#cb25-220" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb25-221"><a href="#cb25-221" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o_join =</span> DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-222"><a href="#cb25-222" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_rev_o =</span> <span class="fu">max</span>(DP_o) <span class="sc">-</span> DP_o <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb25-223"><a href="#cb25-223" tabindex="-1"></a></span>
<span id="cb25-224"><a href="#cb25-224" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">AP_o =</span> latest_observed<span class="sc">$</span>AP_o,</span>
<span id="cb25-225"><a href="#cb25-225" tabindex="-1"></a>                           <span class="at">DP_o =</span> clmodel<span class="sc">$</span>DP_o_join) <span class="sc">%&gt;%</span></span>
<span id="cb25-226"><a href="#cb25-226" tabindex="-1"></a>  <span class="fu">left_join</span>(clmodel[, <span class="fu">c</span>(<span class="st">&quot;DP_o_join&quot;</span>, <span class="st">&quot;df&quot;</span>)], <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;DP_o&quot;</span> <span class="ot">=</span> <span class="st">&quot;DP_o_join&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-227"><a href="#cb25-227" tabindex="-1"></a>  <span class="fu">left_join</span>(latest_observed, <span class="at">by =</span> <span class="st">&quot;AP_o&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-228"><a href="#cb25-228" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-229"><a href="#cb25-229" tabindex="-1"></a>  <span class="fu">filter</span>(DP_o <span class="sc">&gt;</span> DP_max) <span class="sc">%&gt;%</span></span>
<span id="cb25-230"><a href="#cb25-230" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-231"><a href="#cb25-231" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-232"><a href="#cb25-232" tabindex="-1"></a>  <span class="fu">arrange</span>(DP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-233"><a href="#cb25-233" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">df_cum =</span> <span class="fu">cumprod</span>(df)) <span class="sc">%&gt;%</span></span>
<span id="cb25-234"><a href="#cb25-234" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_expected =</span> I <span class="sc">*</span> df_cum <span class="sc">-</span> I <span class="sc">*</span> <span class="fu">lag</span>(df_cum, <span class="at">default =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-235"><a href="#cb25-235" tabindex="-1"></a>  <span class="fu">select</span>(DP_o, AP_o, I_expected)</span>
<span id="cb25-236"><a href="#cb25-236" tabindex="-1"></a></span>
<span id="cb25-237"><a href="#cb25-237" tabindex="-1"></a>conversion_factor <span class="ot">&lt;-</span> individual_data<span class="sc">$</span>conversion_factor</span>
<span id="cb25-238"><a href="#cb25-238" tabindex="-1"></a>max_dp_i <span class="ot">&lt;-</span> <span class="dv">1440</span></span>
<span id="cb25-239"><a href="#cb25-239" tabindex="-1"></a>score_total <span class="ot">&lt;-</span> predictions  <span class="sc">%&gt;%</span></span>
<span id="cb25-240"><a href="#cb25-240" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output_cl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-241"><a href="#cb25-241" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ave =</span> I <span class="sc">-</span> I_expected, <span class="at">abs_ave =</span> <span class="fu">abs</span>(ave)) <span class="sc">%&gt;%</span></span>
<span id="cb25-242"><a href="#cb25-242" tabindex="-1"></a>  <span class="co"># from here it is reformulated for the are tot</span></span>
<span id="cb25-243"><a href="#cb25-243" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-244"><a href="#cb25-244" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-245"><a href="#cb25-245" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(ave)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-246"><a href="#cb25-246" tabindex="-1"></a></span>
<span id="cb25-247"><a href="#cb25-247" tabindex="-1"></a>are_tot <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>abs_ave) <span class="sc">/</span> <span class="fu">sum</span>(score_total<span class="sc">$</span>I)</span>
<span id="cb25-248"><a href="#cb25-248" tabindex="-1"></a></span>
<span id="cb25-249"><a href="#cb25-249" tabindex="-1"></a>score_diagonal <span class="ot">&lt;-</span> individual_data<span class="sc">$</span>full.data  <span class="sc">%&gt;%</span></span>
<span id="cb25-250"><a href="#cb25-250" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-251"><a href="#cb25-251" tabindex="-1"></a>    <span class="at">DP_rev_o =</span> <span class="fu">floor</span>(max_dp_i <span class="sc">*</span> conversion_factor) <span class="sc">-</span></span>
<span id="cb25-252"><a href="#cb25-252" tabindex="-1"></a>      <span class="fu">ceiling</span>(</span>
<span id="cb25-253"><a href="#cb25-253" tabindex="-1"></a>              DP_i <span class="sc">*</span> conversion_factor <span class="sc">+</span></span>
<span id="cb25-254"><a href="#cb25-254" tabindex="-1"></a>                ((AP_i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> (</span>
<span id="cb25-255"><a href="#cb25-255" tabindex="-1"></a>                  <span class="dv">1</span> <span class="sc">/</span> conversion_factor</span>
<span id="cb25-256"><a href="#cb25-256" tabindex="-1"></a>                )) <span class="sc">*</span> conversion_factor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb25-257"><a href="#cb25-257" tabindex="-1"></a>    <span class="at">AP_o =</span> <span class="fu">ceiling</span>(AP_i <span class="sc">*</span> conversion_factor)</span>
<span id="cb25-258"><a href="#cb25-258" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-259"><a href="#cb25-259" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-260"><a href="#cb25-260" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_type =</span> <span class="fu">as.character</span>(claim_type)) <span class="sc">%&gt;%</span></span>
<span id="cb25-261"><a href="#cb25-261" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">I =</span> <span class="fu">sum</span>(I), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-262"><a href="#cb25-262" tabindex="-1"></a>  <span class="fu">group_by</span>(claim_type, AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-263"><a href="#cb25-263" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(DP_rev_o)) <span class="sc">%&gt;%</span></span>
<span id="cb25-264"><a href="#cb25-264" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum =</span> <span class="fu">cumsum</span>(I)) <span class="sc">%&gt;%</span></span>
<span id="cb25-265"><a href="#cb25-265" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_lag =</span> <span class="fu">lag</span>(I_cum, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-266"><a href="#cb25-266" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DP_o =</span> <span class="fu">max</span>(individual_data<span class="sc">$</span>training.data<span class="sc">$</span>DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-267"><a href="#cb25-267" tabindex="-1"></a>  <span class="fu">left_join</span>(CL[, <span class="fu">c</span>(<span class="st">&quot;DP_o&quot;</span>, <span class="st">&quot;df&quot;</span>)], <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;DP_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-268"><a href="#cb25-268" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">I_cum_hat =</span>  I_cum_lag <span class="sc">*</span> df,</span>
<span id="cb25-269"><a href="#cb25-269" tabindex="-1"></a>         <span class="at">RP_o =</span> <span class="fu">max</span>(DP_rev_o) <span class="sc">-</span> DP_rev_o <span class="sc">+</span> AP_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-270"><a href="#cb25-270" tabindex="-1"></a>  <span class="fu">inner_join</span>(true_output_cl[, <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)] <span class="sc">%&gt;%</span>  <span class="fu">distinct</span>()</span>
<span id="cb25-271"><a href="#cb25-271" tabindex="-1"></a>             , <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;AP_o&quot;</span>, <span class="st">&quot;DP_rev_o&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-272"><a href="#cb25-272" tabindex="-1"></a>  <span class="fu">group_by</span>(AP_o, DP_rev_o) <span class="sc">%&gt;%</span></span>
<span id="cb25-273"><a href="#cb25-273" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">abs_ave2_diag =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(I_cum_hat) <span class="sc">-</span> <span class="fu">sum</span>(I_cum)), <span class="at">I =</span> <span class="fu">sum</span>(I))</span>
<span id="cb25-274"><a href="#cb25-274" tabindex="-1"></a></span>
<span id="cb25-275"><a href="#cb25-275" tabindex="-1"></a>are_cal_q <span class="ot">&lt;-</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>abs_ave2_diag) <span class="sc">/</span> <span class="fu">sum</span>(score_diagonal<span class="sc">$</span>I)</span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
